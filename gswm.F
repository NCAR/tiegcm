!      
      module gswm_module
      use params_module,only: nlon,nlat,nlonp4
!      
! module used to read in output data from the GSWM model (Z,TN,UN and VN)
! Z [m] TN [K} UN,VN [m/s]
! converted for TIEGCM to Z [cm] TN [K} UN,VN [cm/s]
! subroutines rdgswmdi & rdgswmsdi
! so far the GSWM output for the whole year (one day per month) is read
! can be changed to only part of the year- however the interpolation 
! subroutines getgswmdi & getgswmsdi will change too
!
      implicit none
!
#ifdef SUN
#include "netcdf3.inc"
#else
#include "netcdf.inc"
#endif 
! 
! Global gswm data read from gswm data file:
!  (assume always one day of hourly values for each month and one year)
      integer,parameter :: 
     |  mxgswmyear = 1,  ! maximum number of years  of gswm data
     |  mxgswmmonth= 12, ! maximum number of months of gswm data
     |  mxgswmhour = 24  ! maximum number of hours  of gswm data
      integer :: 
     |  ngswmmonth,      ! number of months of gswm data
     |  ngswmtime        ! number of hourly gswm data
      real ::
     |  gswm_di_z(nlon,nlat,mxgswmmonth,mxgswmhour),    ! diurnal tides data
     |  gswm_di_tn(nlon,nlat,mxgswmmonth,mxgswmhour),   ! diurnal tides data
     |  gswm_di_un(nlon,nlat,mxgswmmonth,mxgswmhour),   ! diurnal tides data
     |  gswm_di_vn(nlon,nlat,mxgswmmonth,mxgswmhour),   ! diurnal tides data
     |  gswm_sdi_z(nlon,nlat,mxgswmmonth,mxgswmhour),   ! semidiurnal tides data
     |  gswm_sdi_tn(nlon,nlat,mxgswmmonth,mxgswmhour),  ! semidiurnal tides data
     |  gswm_sdi_un(nlon,nlat,mxgswmmonth,mxgswmhour),  ! semidiurnal tides data
     |  gswm_sdi_vn(nlon,nlat,mxgswmmonth,mxgswmhour),  ! semidiurnal tides data
     |  gswm_nmidi_z(nlon,nlat,mxgswmmonth,mxgswmhour),  ! nonmigrating diurnal tides data
     |  gswm_nmidi_tn(nlon,nlat,mxgswmmonth,mxgswmhour), ! nonmigrating diurnal tides data
     |  gswm_nmidi_un(nlon,nlat,mxgswmmonth,mxgswmhour), ! nonmigrating diurnal tides data
     |  gswm_nmidi_vn(nlon,nlat,mxgswmmonth,mxgswmhour), ! nonmigrating diurnal tides data
     |  gswm_nmisdi_z(nlon,nlat,mxgswmmonth,mxgswmhour), ! nonmigrating semidiurnal tides data
     |  gswm_nmisdi_tn(nlon,nlat,mxgswmmonth,mxgswmhour),! nonmigrating semidiurnal tides data
     |  gswm_nmisdi_un(nlon,nlat,mxgswmmonth,mxgswmhour),! nonmigrating semidiurnal tides data
     |  gswm_nmisdi_vn(nlon,nlat,mxgswmmonth,mxgswmhour),! nonmigrating semidiurnal tides data
     |  zdi_gswm(nlonp4,nlat),tndi_gswm(nlonp4,nlat),    ! diurnal tides boundary
     |  undi_gswm(nlonp4,nlat),vndi_gswm(nlonp4,nlat),   ! diurnal tides boundary
     |  zsdi_gswm(nlonp4,nlat),tnsdi_gswm(nlonp4,nlat),  ! semidiurnal tides boundary
     |  unsdi_gswm(nlonp4,nlat),vnsdi_gswm(nlonp4,nlat), ! semidiurnal tides boundary
     |  znmidi_gswm(nlonp4,nlat),tnnmidi_gswm(nlonp4,nlat),   ! nonmigrating diurnal tides boundary
     |  unnmidi_gswm(nlonp4,nlat),vnnmidi_gswm(nlonp4,nlat),  ! nonmigrating diurnal tides boundary
     |  znmisdi_gswm(nlonp4,nlat),tnnmisdi_gswm(nlonp4,nlat), ! nonmigrating semidiurnal tides boundary
     |  unnmisdi_gswm(nlonp4,nlat),vnnmisdi_gswm(nlonp4,nlat) ! nonmigrating semidiurnal tides boundary
!
      contains 
!-----------------------------------------------------------------------
      subroutine rdgswmdi
!
! Obtain and read gswm_di_ncfile netcdf data file containing T,UN,VN and Z. 
! These data is generated by the ouput of the GSWM. 
!
      use input_module,only: tempdir,gswm_di_ncfile
      use nchist_module,only:nc_open,nc_close,handle_ncerr
!
! Local:
      character(len=80) :: dskfile
      integer :: istat,ncid,i,j,ier
      integer :: id_nmonth,id_ntime,id_nlon,id_nlat,idv_z,idv_tn,
     |    idv_un,idv_vn,ngswmlon,ngswmlat
!
! Acquire mss file:
      call mkdiskflnm(gswm_di_ncfile,dskfile)
      call getms(gswm_di_ncfile,dskfile,tempdir,' ')
!
      write(6,"(/,72('-'))")
      write(6,"('RDGSWMDI: read GSWM diurnal tidal data file:')")
!
! Open netcdf file:
      call nc_open(ncid,dskfile,'OLD','READ')
      if (ncid==0) then
        write(6,"(/,'>>> rdgswmdi: error opening netcdf gswm ',
     |    'diurnal file ',a)") trim(dskfile)
        stop 'rdgswmdi'
      endif
!
! Get nmonth dimension:
      istat = nf_inq_dimid(ncid,'nmonth',id_nmonth)
      istat = nf_inq_dimlen(ncid,id_nmonth,ngswmmonth)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting nmonth dimension')
      if (ngswmmonth > mxgswmmonth) then
        write(6,"(/,'>>> rdgswmdi: need to increase mxgswmmonth: ',
     |    'mxgswmmonth=',i8,' ngswmmonth=',i8)") mxgswmmonth,
     |    ngswmmonth
        stop 'rdgswmdi'
      endif
!
! Get ntime dimension:
      istat = nf_inq_dimid(ncid,'time',id_ntime)
      istat = nf_inq_dimlen(ncid,id_ntime,ngswmtime)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting time dimension')
      if (ngswmtime > mxgswmhour) then
        write(6,"(/,'>>> rdgswmdi: input hourly data: ',
     |    'mxgswmhour=',i8,' ngswmtime=',i8)") mxgswmhour,
     |    ngswmtime
        stop 'rdgswmdi'
      endif
!
! Get nlon dimension:
      istat = nf_inq_dimid(ncid,'lon',id_nlon)
      istat = nf_inq_dimlen(ncid,id_nlon,ngswmlon)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting lon dimension')
      if (ngswmlon /= nlon) then
        write(6,"(/,'>>> rdgswmdi: longitudinal dim does not fit: ',
     |    'nlon(GSWM)=',i8,' nlon(TIEGCM)=',i8)") ngswmlon,
     |    nlon
        stop 'rdgswmdi'
      endif
!
! Get nlat dimension:
      istat = nf_inq_dimid(ncid,'lat',id_nlat)
      istat = nf_inq_dimlen(ncid,id_nlat,ngswmlat)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting lat dimension')
      if (ngswmlat /= nlat) then
        write(6,"(/,'>>> rdgswmdi: latitudinal dim does not fit: ',
     |    'nlat(GSWM)=',i8,' nlat(TIEGCM)=',i8)") ngswmlat,
     |    nlat
        stop 'rdgswmdi'
      endif
!
! Get Z (geopotential height perturbation [m]:
      istat = nf_inq_varid(ncid,'Z',idv_z)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting Z var id')
      istat = nf_get_var_double(ncid,idv_z,gswm_di_z)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswm: Error getting variable Z')
      gswm_di_z = gswm_di_z*100. 	! convert to cm
!
! Get TN (neutral temperature perturbation [deg K]:
      istat = nf_inq_varid(ncid,'TN',idv_tn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting TN var id')
      istat = nf_get_var_double(ncid,idv_tn,gswm_di_tn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswm: Error getting variable TN')
!
! Get UN (neutral zonal wind perturbation [m/s]:
      istat = nf_inq_varid(ncid,'UN',idv_un)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting UN var id')
      istat = nf_get_var_double(ncid,idv_un,gswm_di_un)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswm: Error getting variable UN')
      gswm_di_un = gswm_di_un*100. 	! convert to cm/s
!
! Get VN (neutral meridional wind perturbation [m/s]:
      istat = nf_inq_varid(ncid,'VN',idv_vn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting VN var id')
      istat = nf_get_var_double(ncid,idv_vn,gswm_di_vn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswm: Error getting variable VN')
      gswm_di_vn = gswm_di_vn*100. 	! convert to cm/s
!
! Close the file:
      call nc_close(ncid)
      write(6,"('Completed read from GSWMDI data file ',a)")
     |   trim(dskfile)
      write(6,"(72('-'),/)")
      
      end subroutine rdgswmdi
!-----------------------------------------------------------------------
      subroutine rdgswmsdi
!
! Obtain and read gswm_sdi_ncfile netcdf data file containing T,UN,VN and Z. 
! These data is generated by the ouput of the GSWM. 
!
      use input_module,only: tempdir,gswm_sdi_ncfile
      use nchist_module,only:nc_open,nc_close,handle_ncerr
!
! Local:
      character(len=80) :: dskfile
      integer :: istat,ncid,i,j,ier
      integer :: id_nmonth,id_ntime,id_nlon,id_nlat,idv_z,idv_tn,
     |   idv_un,idv_vn,ngswmlon,ngswmlat
!
! Acquire mss file:
      call mkdiskflnm(gswm_sdi_ncfile,dskfile)
      call getms(gswm_sdi_ncfile,dskfile,tempdir,' ')
!
      write(6,"(/,72('-'))")
      write(6,"('RDGSWMSDI: read GSWM semidiurnal tidal data file:')")
!
! Open netcdf file:
      call nc_open(ncid,dskfile,'OLD','READ')
      if (ncid==0) then
        write(6,"(/,'>>> rdgswmdi: error opening netcdf gswm ',
     |    'semidiurnal file ',a)") trim(dskfile)
        stop 'rdgswmsdi'
      endif
!
! Get nmonth dimension:
      istat = nf_inq_dimid(ncid,'nmonth',id_nmonth)
      istat = nf_inq_dimlen(ncid,id_nmonth,ngswmmonth)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmsdi: Error getting nmonth dimension')
      if (ngswmmonth > mxgswmmonth) then
        write(6,"(/,'>>> rdgswmsdi: need to increase mxgswmmonth: ',
     |    'mxgswmmonth=',i8,' ngswmmonth=',i8)") mxgswmmonth,
     |    ngswmmonth
        stop 'rdgswmsdi'
      endif
!
! Get ntime dimension:
      istat = nf_inq_dimid(ncid,'time',id_ntime)
      istat = nf_inq_dimlen(ncid,id_ntime,ngswmtime)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmsdi: Error getting time dimension')
      if (ngswmtime > mxgswmhour) then
        write(6,"(/,'>>> rdgswmdi: input hourly data: ',
     |    'mxgswmhour=',i8,' ngswmtime=',i8)") mxgswmhour,
     |    ngswmtime
        stop 'rdgswmsdi'
      endif
!
! Get nlon dimension:
      istat = nf_inq_dimid(ncid,'lon',id_nlon)
      istat = nf_inq_dimlen(ncid,id_nlon,ngswmlon)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmsdi: Error getting lon dimension')
      if (ngswmlon /= nlon) then
        write(6,"(/,'>>> rdgswmsdi: longitudinal dim does not fit: ',
     |    'nlon(GSWM)=',i8,' nlon(TIEGCM)=',i8)") ngswmlon,
     |    nlon
        stop 'rdgswmsdi'
      endif
!
! Get nlat dimension:
      istat = nf_inq_dimid(ncid,'lat',id_nlat)
      istat = nf_inq_dimlen(ncid,id_nlat,ngswmlat)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmsdi: Error getting lat dimension')
      if (ngswmlat /= nlat) then
        write(6,"(/,'>>> rdgswmsdi: latitudinal dim does not fit: ',
     |    'nlat(GSWM)=',i8,' nlat(TIEGCM)=',i8)") ngswmlat,
     |    nlat
        stop 'rdgswmsdi'
      endif
!
! Get Z (geopotential height perturbation [m]:
      istat = nf_inq_varid(ncid,'Z',idv_z)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmsdi: Error getting Z var id')
      istat = nf_get_var_double(ncid,idv_z,gswm_sdi_z)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmsdi: Error getting variable Z')
      gswm_sdi_z = gswm_sdi_z*100. 	! convert to cm
!
! Get TN (neutral temperature perturbation [deg K]:
      istat = nf_inq_varid(ncid,'TN',idv_tn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting TN var id')
      istat = nf_get_var_double(ncid,idv_tn,gswm_sdi_tn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmsdi: Error getting variable TN')
!
! Get UN (neutral zonal wind perturbation [m/s]:
      istat = nf_inq_varid(ncid,'UN',idv_un)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting UN var id')
      istat = nf_get_var_double(ncid,idv_un,gswm_sdi_un)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmsdi: Error getting variable UN')
      gswm_sdi_un = gswm_sdi_un*100. 	! convert to cm/s
!
! Get VN (neutral meridional wind perturbation [m/s]:
      istat = nf_inq_varid(ncid,'VN',idv_vn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmdi: Error getting VN var id')
      istat = nf_get_var_double(ncid,idv_vn,gswm_sdi_vn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmsdi: Error getting variable VN')
      gswm_sdi_vn = gswm_sdi_vn*100. 	! convert to cm/s
!
! Close the file:
      call nc_close(ncid)
      write(6,"('Completed read from GSWMSDI data file ',a)")
     |   trim(dskfile)
      write(6,"(72('-'),/)")
      end subroutine rdgswmsdi

!-----------------------------------------------------------------------
      subroutine rdgswmnmidi
!
! Obtain and read gswm_nmidi_ncfile netcdf data file containing T,UN,VN and Z. 
! These data is generated by the ouput of the GSWM. 
!
      use input_module,only: tempdir,gswm_nmidi_ncfile
      use nchist_module,only:nc_open,nc_close,handle_ncerr
!
! Local:
      character(len=80) :: dskfile
      integer :: istat,ncid,i,j,ier
      integer :: id_nmonth,id_ntime,id_nlon,id_nlat,idv_z,idv_tn,
     |    idv_un,idv_vn,ngswmlon,ngswmlat
!
! Acquire mss file:
      call mkdiskflnm(gswm_nmidi_ncfile,dskfile)
      call getms(gswm_nmidi_ncfile,dskfile,tempdir,' ')
!
      write(6,"(/,72('-'))")
      write(6,"('RDGSWMNMIDI: read GSWM nonmigrating diurnal', 
     | ' tidal data file:')")
!
! Open netcdf file:
      call nc_open(ncid,dskfile,'OLD','READ')
      if (ncid==0) then
        write(6,"(/,'>>> rdgswmnmidi: error opening netcdf gswm ',
     |    'nonmigrating diurnal file ',a)") trim(dskfile)
        stop 'rdgswmnmidi'
      endif
!
! Get nmonth dimension:
      istat = nf_inq_dimid(ncid,'nmonth',id_nmonth)
      istat = nf_inq_dimlen(ncid,id_nmonth,ngswmmonth)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting nmonth dimension')
      if (ngswmmonth > mxgswmmonth) then
        write(6,"(/,'>>> rdgswmnmidi: need to increase mxgswmmonth: ',
     |    'mxgswmmonth=',i8,' ngswmmonth=',i8)") mxgswmmonth,
     |    ngswmmonth
        stop 'rdgswmnmidi'
      endif
!
! Get ntime dimension:
      istat = nf_inq_dimid(ncid,'time',id_ntime)
      istat = nf_inq_dimlen(ncid,id_ntime,ngswmtime)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting time dimension')
      if (ngswmtime > mxgswmhour) then
        write(6,"(/,'>>> rdgswmnmidi: input hourly data: ',
     |    'mxgswmhour=',i8,' ngswmtime=',i8)") mxgswmhour,
     |    ngswmtime
        stop 'rdgswmnmidi'
      endif
!
! Get nlon dimension:
      istat = nf_inq_dimid(ncid,'lon',id_nlon)
      istat = nf_inq_dimlen(ncid,id_nlon,ngswmlon)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting lon dimension')
      if (ngswmlon /= nlon) then
        write(6,"(/,'>>> rdgswmnmidi: longitudinal dim does not fit: ',
     |    'nlon(GSWM)=',i8,' nlon(TIEGCM)=',i8)") ngswmlon,
     |    nlon
        stop 'rdgswmnmidi'
      endif
!
! Get nlat dimension:
      istat = nf_inq_dimid(ncid,'lat',id_nlat)
      istat = nf_inq_dimlen(ncid,id_nlat,ngswmlat)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting lat dimension')
      if (ngswmlat /= nlat) then
        write(6,"(/,'>>> rdgswmnmidi: latitudinal dim does not fit: ',
     |    'nlat(GSWM)=',i8,' nlat(TIEGCM)=',i8)") ngswmlat,
     |    nlat
        stop 'rdgswmnmidi'
      endif
!
! Get Z (geopotential height perturbation [m]:
      istat = nf_inq_varid(ncid,'Z',idv_z)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting Z var id')
      istat = nf_get_var_double(ncid,idv_z,gswm_nmidi_z)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting variable Z')
      gswm_nmidi_z = gswm_nmidi_z*100. 	! convert to cm
!
! Get TN (neutral temperature perturbation [deg K]:
      istat = nf_inq_varid(ncid,'TN',idv_tn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting TN var id')
      istat = nf_get_var_double(ncid,idv_tn,gswm_nmidi_tn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting variable TN')
!
! Get UN (neutral zonal wind perturbation [m/s]:
      istat = nf_inq_varid(ncid,'UN',idv_un)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting UN var id')
      istat = nf_get_var_double(ncid,idv_un,gswm_nmidi_un)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting variable UN')
      gswm_nmidi_un = gswm_nmidi_un*100. 	! convert to cm/s
!
! Get VN (neutral meridional wind perturbation [m/s]:
      istat = nf_inq_varid(ncid,'VN',idv_vn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting VN var id')
      istat = nf_get_var_double(ncid,idv_vn,gswm_nmidi_vn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmidi: Error getting variable VN')
      gswm_nmidi_vn = gswm_nmidi_vn*100. 	! convert to cm/s
!
! Close the file:
      call nc_close(ncid)
      write(6,"('Completed read from GSWMNMIDI data file ',a)")
     |   trim(dskfile)
      write(6,"(72('-'),/)")
      
      end subroutine rdgswmnmidi

!-----------------------------------------------------------------------
      subroutine rdgswmnmisdi
!
! Obtain and read gswm_nmisdi_ncfile netcdf data file containing T,UN,VN and Z. 
! These data is generated by the ouput of the GSWM. 
!
      use input_module,only: tempdir,gswm_nmisdi_ncfile
      use nchist_module,only:nc_open,nc_close,handle_ncerr
!
! Local:
      character(len=80) :: dskfile
      integer :: istat,ncid,i,j,ier
      integer :: id_nmonth,id_ntime,id_nlon,id_nlat,idv_z,idv_tn,
     |    idv_un,idv_vn,ngswmlon,ngswmlat
!
! Acquire mss file:
      call mkdiskflnm(gswm_nmisdi_ncfile,dskfile)
      call getms(gswm_nmisdi_ncfile,dskfile,tempdir,' ')
!
      write(6,"(/,72('-'))")
      write(6,"('RDGSWMNMISDI: read GSWM nonmigrating semidiurnal', 
     | ' tidal data file:')")
!
! Open netcdf file:
      call nc_open(ncid,dskfile,'OLD','READ')
      if (ncid==0) then
        write(6,"(/,'>>> rdgswmnmisdi: error opening netcdf gswm ',
     |    'nonmigrating semidiurnal file ',a)") trim(dskfile)
        stop 'rdgswmnmisdi'
      endif
!
! Get nmonth dimension:
      istat = nf_inq_dimid(ncid,'nmonth',id_nmonth)
      istat = nf_inq_dimlen(ncid,id_nmonth,ngswmmonth)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting nmonth dimension')
      if (ngswmmonth > mxgswmmonth) then
        write(6,"(/,'>>> rdgswmnmisdi: need to increase mxgswmmonth: ',
     |    'mxgswmmonth=',i8,' ngswmmonth=',i8)") mxgswmmonth,
     |    ngswmmonth
        stop 'rdgswmnmisdi'
      endif
!
! Get ntime dimension:
      istat = nf_inq_dimid(ncid,'time',id_ntime)
      istat = nf_inq_dimlen(ncid,id_ntime,ngswmtime)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting time dimension')
      if (ngswmtime > mxgswmhour) then
        write(6,"(/,'>>> rdgswmnmisdi: input hourly data: ',
     |    'mxgswmhour=',i8,' ngswmtime=',i8)") mxgswmhour,
     |    ngswmtime
        stop 'rdgswmnmisdi'
      endif
!
! Get nlon dimension:
      istat = nf_inq_dimid(ncid,'lon',id_nlon)
      istat = nf_inq_dimlen(ncid,id_nlon,ngswmlon)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting lon dimension')
      if (ngswmlon /= nlon) then
        write(6,"(/,'>>> rdgswmnmisdi: longitudinal dim does not ',
     |    'fit: nlon(GSWM)=',i8,' nlon(TIEGCM)=',i8)") ngswmlon,
     |    nlon
        stop 'rdgswmnmisdi'
      endif
!
! Get nlat dimension:
      istat = nf_inq_dimid(ncid,'lat',id_nlat)
      istat = nf_inq_dimlen(ncid,id_nlat,ngswmlat)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting lat dimension')
      if (ngswmlat /= nlat) then
        write(6,"(/,'>>> rdgswmnmisdi: latitudinal dim does not fit: ',
     |    'nlat(GSWM)=',i8,' nlat(TIEGCM)=',i8)") ngswmlat,
     |    nlat
        stop 'rdgswmnmisdi'
      endif
!
! Get Z (geopotential height perturbation [m]:
      istat = nf_inq_varid(ncid,'Z',idv_z)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting Z var id')
      istat = nf_get_var_double(ncid,idv_z,gswm_nmisdi_z)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting variable Z')
      gswm_nmisdi_z = gswm_nmisdi_z*100. 	! convert to cm
!
! Get TN (neutral temperature perturbation [deg K]:
      istat = nf_inq_varid(ncid,'TN',idv_tn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting TN var id')
      istat = nf_get_var_double(ncid,idv_tn,gswm_nmisdi_tn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting variable TN')
!
! Get UN (neutral zonal wind perturbation [m/s]:
      istat = nf_inq_varid(ncid,'UN',idv_un)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting UN var id')
      istat = nf_get_var_double(ncid,idv_un,gswm_nmisdi_un)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting variable UN')
      gswm_nmisdi_un = gswm_nmisdi_un*100. 	! convert to cm/s
!
! Get VN (neutral meridional wind perturbation [m/s]:
      istat = nf_inq_varid(ncid,'VN',idv_vn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting VN var id')
      istat = nf_get_var_double(ncid,idv_vn,gswm_nmisdi_vn)
      if (istat /= NF_NOERR) call handle_ncerr(istat,
     |  'rdgswmnmisdi: Error getting variable VN')
      gswm_nmisdi_vn = gswm_nmisdi_vn*100. 	! convert to cm/s
!
! Close the file:
      call nc_close(ncid)
      write(6,"('Completed read from GSWMNMISDI data file ',a)")
     |   trim(dskfile)
      write(6,"(72('-'),/)")
      
      end subroutine rdgswmnmisdi
!-----------------------------------------------------------------------
      subroutine getgswmdi(iyear,iday,iutsec,iprint)
!
! Use gswm data read from gswm_di_ncfile file to return perturbation in Z
! and T at current date and time. It is assumed that the gswm_di_ncfile
! provides data for a whole year with one day of data for each month
! with hourly values (0 UT to 23 UT)
! the data is linearly interpolated first to the model UT for the
! corresponding months (current and next month) and then linearly
! interpolated to the modelday
!
      use hist_module,only: modeltime
!
! Args:
      integer,intent(in) :: iyear,iday,iutsec,iprint
!
! Local:
      integer :: i,j,ndmon_nl(13),ndmon_lp(13),nonleap,
     |   mon_cur,mon_nxt,ihr_cur,ihr_nxt,nointp=0
      real :: difsec,difday,sec,secint,dayint,
     |   z_curmo(nlon,nlat)=0.,z_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   tn_curmo(nlon,nlat)=0.,tn_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   un_curmo(nlon,nlat)=0.,un_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   vn_curmo(nlon,nlat)=0.,vn_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   z_tmp(nlon,nlat)=0.,tn_tmp(nlon,nlat)=0.,	! tmp 
     |   un_tmp(nlon,nlat)=0.,vn_tmp(nlon,nlat)=0.	! tmp 

!   
! Data: GSWM data given at the middle of each month 
!       -> day of year for this data assuming non-leap year
!         J  F  M  A   M   J   J   A   S   O   N   D   J
      data ndmon_nl                                ! non_leap
     |  /15,46,74,105,135,166,196,227,258,288,319,349,380/ 
! 
! External:
      real,external :: finterp
!
      if (iprint > 0) then
        write(6,"(/,72('-'))")
        write(6,"('GETGSWMDI: get diurnal tidal perturbation from ',
     |     'database:')")
        write(6,"('Initial requested iyear=',i4,' iday=',i3,' iutsec=',
     |    i10)") iyear,iday,iutsec
      endif
! 
! Get month of model run
      do i = 1,13
        if(iday.le.ndmon_nl(i)) goto 10
      enddo
 10   mon_nxt = i		! next month
      if(mon_nxt == 13 ) mon_nxt = 1
      mon_cur = i-1		! current month
      if(mon_cur == 0 ) mon_cur = 12
! 
! Get hour of model run (model hours from 0 to 23 )
      ihr_cur = modeltime(2)	! current hour
      ihr_nxt = modeltime(2)+1  ! next hour
      if(ihr_nxt == 24 ) ihr_nxt = 1
      
! 
! GSWM hourly data from 0 UT (i=1) to 23 UT (i=24) resp. 0 utsec  
!
! Check times:
!
      if (modeltime(3).lt.0.or.modeltime(3).gt.59) then
        write(6,"('>>> getgswmdi: bad imin=',3i4)") modeltime(3)
        stop 'getgswmdi'
      endif
      if (modeltime(4).lt.0.or.modeltime(4).gt.59) then
        write(6,"('>>> getgswmdi: bad isec=',3i4)") modeltime(4)
        stop 'getgswmdi'
      endif
      
! Interpolate to modeltime iutsec for each month: mon_cur mon_nxt
      
      if (iutsec==0) then      ! no interpolation
        z_curmo(:,:)  = gswm_di_z(:,:,mon_cur,ihr_cur+1)  ! current month
        tn_curmo(:,:) = gswm_di_tn(:,:,mon_cur,ihr_cur+1)
        un_curmo(:,:) = gswm_di_un(:,:,mon_cur,ihr_cur+1)
        vn_curmo(:,:) = gswm_di_vn(:,:,mon_cur,ihr_cur+1)
        z_nxtmo(:,:)  = gswm_di_z(:,:,mon_nxt,ihr_cur+1)  ! next month
        tn_nxtmo(:,:) = gswm_di_tn(:,:,mon_nxt,ihr_cur+1)
        un_nxtmo(:,:) = gswm_di_un(:,:,mon_nxt,ihr_cur+1)
        vn_nxtmo(:,:) = gswm_di_vn(:,:,mon_nxt,ihr_cur+1)
      else
        difsec = 60.*60. ! difference in sec between ihr_cur and ihr_nxt
        secint = float(modeltime(3)*60 + modeltime(4))	! interpolation time [sec]
	
        call timeliper_array(gswm_di_z(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_di_z(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,z_curmo,1)
        call timeliper_array(gswm_di_tn(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_di_tn(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,tn_curmo,1)
        call timeliper_array(gswm_di_un(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_di_un(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,un_curmo,1)
        call timeliper_array(gswm_di_vn(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_di_vn(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,vn_curmo,1)
        call timeliper_array(gswm_di_z(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_di_z(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,z_nxtmo,1)
        call timeliper_array(gswm_di_tn(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_di_tn(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,tn_nxtmo,1)
        call timeliper_array(gswm_di_un(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_di_un(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,un_nxtmo,1)
        call timeliper_array(gswm_di_vn(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_di_vn(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,vn_nxtmo,1)
      endif  
!
! Interpolate to modelday (iday)
!
! Check if interpolation is necessary
      nointp = 0
      if(iday.eq.ndmon_nl(mon_cur)) then ! same day as cur. month
         nointp = 1 
         goto 20
      endif
      if(iday.eq.ndmon_nl(mon_nxt)) then ! same day as next month
         nointp = 2  
         goto 20
      endif
	  
! If interpolation is necessary calculated the time differences      
      if(mon_cur /= 12) then			       ! not December
        difday = ndmon_nl(mon_nxt)-ndmon_nl(mon_cur)   ! difference in days
        dayint = iday - ndmon_nl(mon_cur) ! difference to interpolation day
      else					       ! December wrap around
        difday = ndmon_nl(mon_cur+1)-ndmon_nl(mon_cur) ! difference in days
        if(iday.lt.ndmon_nl(mon_nxt)) then ! difference to interpolation day
           dayint = 365. - ndmon_nl(mon_cur)+  iday
        else
          dayint = iday - ndmon_nl(mon_cur)  
        endif
      endif 
!  
 20   continue  	! if no interpolation is necessary (nointp /= 0)
 
      if (nointp==0) then      ! interpolation
        call timeliper_array(z_curmo,z_nxtmo,difday,dayint,
     |           z_tmp,1)
        call timeliper_array(tn_curmo,tn_nxtmo,difday,dayint,
     |           tn_tmp,1)
        call timeliper_array(un_curmo,un_nxtmo,difday,dayint,
     |           un_tmp,1)
        call timeliper_array(vn_curmo,vn_nxtmo,difday,dayint,
     |           vn_tmp,1)
      elseif(nointp == 1) then    ! no interpolation same day as current month
        zdi_gswm(3:74,:)  = z_curmo
	tndi_gswm(3:74,:) = tn_curmo
	undi_gswm(3:74,:) = un_curmo
	vndi_gswm(3:74,:) = vn_curmo
	goto 30
      elseif(nointp == 2) then    ! no interpolation same day as next month
        zdi_gswm(3:74,:)  = z_nxtmo
	tndi_gswm(3:74,:) = tn_nxtmo
	undi_gswm(3:74,:) = un_nxtmo
	vndi_gswm(3:74,:) = vn_nxtmo
	goto 30
      endif
!
      zdi_gswm(3:74,:)  =  z_tmp
      tndi_gswm(3:74,:) = tn_tmp
      undi_gswm(3:74,:) = un_tmp
      vndi_gswm(3:74,:) = vn_tmp
! periodic points
 30   zdi_gswm(1:2,:)  = z_tmp(71:72,:)
      tndi_gswm(1:2,:) = tn_tmp(71:72,:)
      undi_gswm(1:2,:) = un_tmp(71:72,:)
      vndi_gswm(1:2,:) = vn_tmp(71:72,:)
      zdi_gswm(75:76,:)  = z_tmp(1:2,:)
      tndi_gswm(75:76,:) = tn_tmp(1:2,:)
      undi_gswm(75:76,:) = un_tmp(1:2,:)
      vndi_gswm(75:76,:) = vn_tmp(1:2,:)
!      
      if (iprint > 0) then
        write(6,"('GSWM diurnal tidal pertubation interpolated to ',
     |    'date and time')")
      endif
      end subroutine getgswmdi    

!-----------------------------------------------------------------------
      subroutine getgswmsdi(iyear,iday,iutsec,iprint)
!
! Use gswm data read from gswm_sdi_ncfile file to return perturbation in Z
! and T at current date and time. It is assumed that the gswm_sdi_ncfile
! provides data for a whole year with one day of data for each month
! with hourly values (0 UT to 23 UT)
! the data is linearly interpolated first to the model UT for the
! corresponding months (current and next month) and then linearly
! interpolated to the modelday
!
      use hist_module,only: modeltime
!
! Args:
      integer,intent(in) :: iyear,iday,iutsec,iprint
!
! Local:
      integer :: i,j,ndmon_nl(13),ndmon_lp(13),nonleap,
     |   mon_cur,mon_nxt,ihr_cur,ihr_nxt,nointp=0
      real :: difsec,difday,sec,secint,dayint,
     |   z_curmo(nlon,nlat)=0.,z_nxtmo(nlon,nlat)=0.,	 ! UT interpolation
     |   tn_curmo(nlon,nlat)=0.,tn_nxtmo(nlon,nlat)=0.,	 ! UT interpolation
     |   un_curmo(nlon,nlat)=0.,un_nxtmo(nlon,nlat)=0.,	 ! UT interpolation
     |   vn_curmo(nlon,nlat)=0.,vn_nxtmo(nlon,nlat)=0.,	 ! UT interpolation
     |   z_tmp(nlon,nlat)=0.,tn_tmp(nlon,nlat)=0.,	! tmp 
     |   un_tmp(nlon,nlat)=0.,vn_tmp(nlon,nlat)=0.	! tmp 
!   
! Data: GSWM data given at the middle of each month 
!       -> day of year for this data assuming non-leap year
!         J  F  M  A   M   J   J   A   S   O   N   D   J
      data ndmon_nl                                ! non_leap
     |  /15,46,74,105,135,166,196,227,258,288,319,349,380/ 
! 
! External:
      real,external :: finterp
!
      if (iprint > 0) then
        write(6,"(/,72('-'))")
        write(6,"('GETGSWMSDI: get semidiurnal tidal perturbation ',
     |     'from database:')")
        write(6,"('Initial requested iyear=',i4,' iday=',i3,' iutsec=',
     |    i10)") iyear,iday,iutsec
      endif
      
! 
! Get month of model run
      do i = 1,13
        if(iday.le.ndmon_nl(i)) goto 10
      enddo
 10   mon_nxt = i		! next month
      if(mon_nxt == 13 ) mon_nxt = 1
      mon_cur = i-1		! current month
      if(mon_cur == 0 ) mon_cur = 12
! 
! Get hour of model run (model hours from 0 to 23 )
      ihr_cur = modeltime(2)	! current hour
      ihr_nxt = modeltime(2)+1  ! next hour
      if(ihr_nxt == 24 ) ihr_nxt = 1
! 
! GSWM hourly data from 0 UT (i=1) to 23 UT (i=24) resp. 0 utsec  
!
! Check times: seems not to be necessary
!
      if (modeltime(3).lt.0.or.modeltime(3).gt.59) then
        write(6,"('>>> getgswmsdi: bad imin=',3i4)") modeltime(3)
        stop 'getgswmdi'
      endif
      if (modeltime(4).lt.0.or.modeltime(4).gt.59) then
        write(6,"('>>> getgswmsdi: bad isec=',3i4)") modeltime(4)
        stop 'getgswmdi'
      endif
      
! Interpolate to modeltime iutsec for each month: mon_cur mon_nxt
      
      if (iutsec==0) then      ! no interpolation
        z_curmo(:,:)  = gswm_sdi_z(:,:,mon_cur,ihr_cur+1)  ! current month
        tn_curmo(:,:) = gswm_sdi_tn(:,:,mon_cur,ihr_cur+1)
        un_curmo(:,:) = gswm_sdi_un(:,:,mon_cur,ihr_cur+1)
        vn_curmo(:,:) = gswm_sdi_vn(:,:,mon_cur,ihr_cur+1)
        z_nxtmo(:,:)  = gswm_sdi_z(:,:,mon_nxt,ihr_cur+1)  ! next month
        tn_nxtmo(:,:) = gswm_sdi_tn(:,:,mon_nxt,ihr_cur+1)
        un_nxtmo(:,:) = gswm_sdi_un(:,:,mon_nxt,ihr_cur+1)
        vn_nxtmo(:,:) = gswm_sdi_vn(:,:,mon_nxt,ihr_cur+1)
      else
        difsec = 60.*60. ! difference in sec between ihr_cur and ihr_nxt
        secint = float(modeltime(3)*60 + modeltime(4))	! interpolation time [sec]
	
        call timeliper_array(gswm_sdi_z(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_sdi_z(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,z_curmo,1)
        call timeliper_array(gswm_sdi_tn(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_sdi_tn(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,tn_curmo,1)
        call timeliper_array(gswm_sdi_un(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_sdi_un(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,un_curmo,1)
        call timeliper_array(gswm_sdi_vn(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_sdi_vn(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,vn_curmo,1)
        call timeliper_array(gswm_sdi_z(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_sdi_z(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,z_nxtmo,1)
        call timeliper_array(gswm_sdi_tn(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_sdi_tn(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,tn_nxtmo,1)
        call timeliper_array(gswm_sdi_un(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_sdi_un(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,un_nxtmo,1)
        call timeliper_array(gswm_sdi_vn(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_sdi_vn(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,vn_nxtmo,1)
      endif 
!
! Interpolate to modelday (iday)
! Check if interpolation is necessary
      nointp = 0
      if(iday.eq.ndmon_nl(mon_cur)) then ! same day as cur. month
         nointp = 1 
         goto 20
      endif
      if(iday.eq.ndmon_nl(mon_nxt)) then ! same day as next month
         nointp = 2  
         goto 20
      endif
	  
! If interpolation is necessary calculated the time differences      
      if(mon_cur /= 12) then			       ! not December
        difday = ndmon_nl(mon_nxt)-ndmon_nl(mon_cur)   ! difference in days
        dayint = iday - ndmon_nl(mon_cur) ! difference to interpolation day
      else					       ! December wrap around
        difday = ndmon_nl(mon_cur+1)-ndmon_nl(mon_cur) ! difference in days
        if(iday.lt.ndmon_nl(mon_nxt)) then ! difference to interpolation day
           dayint = 365. - ndmon_nl(mon_cur) +  iday
        else
          dayint = iday - ndmon_nl(mon_cur)  
        endif
      endif
!  
 20   continue  	! if no interpolation is necessary (nointp /= 0)
 
      if (nointp==0) then      ! interpolation
        call timeliper_array(z_curmo,z_nxtmo,difday,dayint,
     |           z_tmp,1)
        call timeliper_array(tn_curmo,tn_nxtmo,difday,dayint,
     |           tn_tmp,1)
        call timeliper_array(un_curmo,un_nxtmo,difday,dayint,
     |           un_tmp,1)
        call timeliper_array(vn_curmo,vn_nxtmo,difday,dayint,
     |           vn_tmp,1)
      elseif(nointp == 1) then    ! no interpolation same day as current month
        zsdi_gswm(3:74,:)  = z_curmo
	tnsdi_gswm(3:74,:) = tn_curmo
	unsdi_gswm(3:74,:) = un_curmo
	vnsdi_gswm(3:74,:) = vn_curmo
	goto 30
      elseif(nointp == 2) then    ! no interpolation same day as next month
        zsdi_gswm(3:74,:)  = z_nxtmo
	tnsdi_gswm(3:74,:) = tn_nxtmo
	unsdi_gswm(3:74,:) = un_nxtmo
	vnsdi_gswm(3:74,:) = vn_nxtmo
	goto 30
      endif
!
      zsdi_gswm(3:74,:)  =  z_tmp
      tnsdi_gswm(3:74,:) = tn_tmp
      unsdi_gswm(3:74,:) = un_tmp
      vnsdi_gswm(3:74,:) = vn_tmp
!
! periodic points
  30  zsdi_gswm(1:2,:)  = z_tmp(71:72,:)
      tnsdi_gswm(1:2,:) = tn_tmp(71:72,:)
      unsdi_gswm(1:2,:) = un_tmp(71:72,:)
      vnsdi_gswm(1:2,:) = vn_tmp(71:72,:)
      zsdi_gswm(75:76,:)  = z_tmp(1:2,:)
      tnsdi_gswm(75:76,:) = tn_tmp(1:2,:)
      unsdi_gswm(75:76,:) = un_tmp(1:2,:)
      vnsdi_gswm(75:76,:) = vn_tmp(1:2,:)
!      
      if (iprint > 0) then
        write(6,"('GSWM semidiurnal tidal pertubation interpolated ',
     |    'to date and time')")
      endif
      end subroutine getgswmsdi    
!-----------------------------------------------------------------------
      subroutine getgswmnmidi(iyear,iday,iutsec,iprint)
!
! Use gswm data read from gswm_nmidi_ncfile file to return perturbation in Z
! T,UN,VN at current date and time. It is assumed that the gswm_nmidi_ncfile
! provides data for a whole year with one day of data for each month
! with hourly values (0 UT to 23 UT)
! the data is linearly interpolated first to the model UT for the
! corresponding months (current and next month) and then linearly
! interpolated to the modelday
!
      use hist_module,only: modeltime
!
! Args:
      integer,intent(in) :: iyear,iday,iutsec,iprint
!
! Local:
      integer :: i,j,ndmon_nl(13),ndmon_lp(13),nonleap,
     |   mon_cur,mon_nxt,ihr_cur,ihr_nxt,nointp=0
      real :: difsec,difday,sec,secint,dayint,
     |   z_curmo(nlon,nlat)=0.,z_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   tn_curmo(nlon,nlat)=0.,tn_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   un_curmo(nlon,nlat)=0.,un_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   vn_curmo(nlon,nlat)=0.,vn_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   z_tmp(nlon,nlat)=0.,tn_tmp(nlon,nlat)=0.,	! tmp 
     |   un_tmp(nlon,nlat)=0.,vn_tmp(nlon,nlat)=0.	! tmp 

!   
! Data: GSWM data given at the middle of each month 
!       -> day of year for this data assuming non-leap year
!         J  F  M  A   M   J   J   A   S   O   N   D   J
      data ndmon_nl                                ! non_leap
     |  /15,46,74,105,135,166,196,227,258,288,319,349,380/ 
! 
! External:
      real,external :: finterp
!
      if (iprint > 0) then
        write(6,"(/,72('-'))")
        write(6,"('GETGSWMNMIDI: get nonmigrating diurnal tidal ',
     |     'perturbation from database:')")
        write(6,"('Initial requested iyear=',i4,' iday=',i3,' iutsec=',
     |    i10)") iyear,iday,iutsec
      endif
! 
! Get month of model run
      do i = 1,13
        if(iday.le.ndmon_nl(i)) goto 10
      enddo
 10   mon_nxt = i		! next month
      if(mon_nxt == 13 ) mon_nxt = 1
      mon_cur = i-1		! current month
      if(mon_cur == 0 ) mon_cur = 12
! 
! Get hour of model run (model hours from 0 to 23 )
      ihr_cur = modeltime(2)	! current hour
      ihr_nxt = modeltime(2)+1  ! next hour
      if(ihr_nxt == 24 ) ihr_nxt = 1
      
! 
! GSWM hourly data from 0 UT (i=1) to 23 UT (i=24) resp. 0 utsec  
!
! Check times:
!
      if (modeltime(3).lt.0.or.modeltime(3).gt.59) then
        write(6,"('>>> getgswmnmidi: bad imin=',3i4)") modeltime(3)
        stop 'getgswmnmidi'
      endif
      if (modeltime(4).lt.0.or.modeltime(4).gt.59) then
        write(6,"('>>> getgswmnmidi: bad isec=',3i4)") modeltime(4)
        stop 'getgswmnmidi'
      endif
      
! Interpolate to modeltime iutsec for each month: mon_cur mon_nxt
      
      if (iutsec==0) then      ! no interpolation
        z_curmo(:,:)  = gswm_nmidi_z(:,:,mon_cur,ihr_cur+1)  ! current month
        tn_curmo(:,:) = gswm_nmidi_tn(:,:,mon_cur,ihr_cur+1)
        un_curmo(:,:) = gswm_nmidi_un(:,:,mon_cur,ihr_cur+1)
        vn_curmo(:,:) = gswm_nmidi_vn(:,:,mon_cur,ihr_cur+1)
        z_nxtmo(:,:)  = gswm_nmidi_z(:,:,mon_nxt,ihr_cur+1)  ! next month
        tn_nxtmo(:,:) = gswm_nmidi_tn(:,:,mon_nxt,ihr_cur+1)
        un_nxtmo(:,:) = gswm_nmidi_un(:,:,mon_nxt,ihr_cur+1)
        vn_nxtmo(:,:) = gswm_nmidi_vn(:,:,mon_nxt,ihr_cur+1)
      else
        difsec = 60.*60. ! difference in sec between ihr_cur and ihr_nxt
        secint = float(modeltime(3)*60 + modeltime(4))	! interpolation time [sec]
	
        call timeliper_array(gswm_nmidi_z(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_nmidi_z(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,z_curmo,1)
        call timeliper_array(gswm_nmidi_tn(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_nmidi_tn(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,tn_curmo,1)
        call timeliper_array(gswm_nmidi_un(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_nmidi_un(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,un_curmo,1)
        call timeliper_array(gswm_nmidi_vn(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_nmidi_vn(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,vn_curmo,1)
        call timeliper_array(gswm_nmidi_z(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_nmidi_z(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,z_nxtmo,1)
        call timeliper_array(gswm_nmidi_tn(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_nmidi_tn(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,tn_nxtmo,1)
        call timeliper_array(gswm_nmidi_un(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_nmidi_un(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,un_nxtmo,1)
        call timeliper_array(gswm_nmidi_vn(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_nmidi_vn(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,vn_nxtmo,1)
      endif  
!
! Interpolate to modelday (iday)
!
! Check if interpolation is necessary
      nointp = 0
      if(iday.eq.ndmon_nl(mon_cur)) then ! same day as cur. month
         nointp = 1 
         goto 20
      endif
      if(iday.eq.ndmon_nl(mon_nxt)) then ! same day as next month
         nointp = 2  
         goto 20
      endif
	  
! If interpolation is necessary calculated the time differences      
      if(mon_cur /= 12) then			       ! not December
        difday = ndmon_nl(mon_nxt)-ndmon_nl(mon_cur)   ! difference in days
        dayint = iday - ndmon_nl(mon_cur) ! difference to interpolation day
      else					       ! December wrap around
        difday = ndmon_nl(mon_cur+1)-ndmon_nl(mon_cur) ! difference in days
        if(iday.lt.ndmon_nl(mon_nxt)) then ! difference to interpolation day
           dayint = 365. - ndmon_nl(mon_cur)+  iday
        else
          dayint = iday - ndmon_nl(mon_cur)  
        endif
      endif 
!  
 20   continue  	! if no interpolation is necessary (nointp /= 0)
 
      if (nointp==0) then      ! interpolation
        call timeliper_array(z_curmo,z_nxtmo,difday,dayint,
     |           z_tmp,1)
        call timeliper_array(tn_curmo,tn_nxtmo,difday,dayint,
     |           tn_tmp,1)
        call timeliper_array(un_curmo,un_nxtmo,difday,dayint,
     |           un_tmp,1)
        call timeliper_array(vn_curmo,vn_nxtmo,difday,dayint,
     |           vn_tmp,1)
      elseif(nointp == 1) then    ! no interpolation same day as current month
        znmidi_gswm(3:74,:)  = z_curmo
	tnnmidi_gswm(3:74,:) = tn_curmo
	unnmidi_gswm(3:74,:) = un_curmo
	vnnmidi_gswm(3:74,:) = vn_curmo
	goto 30
      elseif(nointp == 2) then    ! no interpolation same day as next month
        znmidi_gswm(3:74,:)  = z_nxtmo
	tnnmidi_gswm(3:74,:) = tn_nxtmo
	unnmidi_gswm(3:74,:) = un_nxtmo
	vnnmidi_gswm(3:74,:) = vn_nxtmo
	goto 30
      endif
!
      znmidi_gswm(3:74,:)  =  z_tmp
      tnnmidi_gswm(3:74,:) = tn_tmp
      unnmidi_gswm(3:74,:) = un_tmp
      vnnmidi_gswm(3:74,:) = vn_tmp
! periodic points
 30   znmidi_gswm(1:2,:)   = z_tmp(71:72,:)
      tnnmidi_gswm(1:2,:)  = tn_tmp(71:72,:)
      unnmidi_gswm(1:2,:)  = un_tmp(71:72,:)
      vnnmidi_gswm(1:2,:)  = vn_tmp(71:72,:)
      znmidi_gswm(75:76,:) = z_tmp(1:2,:)
      tnnmidi_gswm(75:76,:)= tn_tmp(1:2,:)
      unnmidi_gswm(75:76,:)= un_tmp(1:2,:)
      vnnmidi_gswm(75:76,:)= vn_tmp(1:2,:)
!      
      if (iprint > 0) then
        write(6,"('GSWM nonmigrating diurnal tidal pertubation ',
     |    'interpolated to date and time')")
      endif
      end subroutine getgswmnmidi    
    
!-----------------------------------------------------------------------
      subroutine getgswmnmisdi(iyear,iday,iutsec,iprint)
!
! Use gswm data read from gswm_nmisdi_ncfile file to return perturbation in Z
! T,UN,VN at current date and time. It is assumed that the gswm_nmisdi_ncfile
! provides data for a whole year with one day of data for each month
! with hourly values (0 UT to 23 UT)
! the data is linearly interpolated first to the model UT for the
! corresponding months (current and next month) and then linearly
! interpolated to the modelday
!
      use hist_module,only: modeltime
!
! Args:
      integer,intent(in) :: iyear,iday,iutsec,iprint
!
! Local:
      integer :: i,j,ndmon_nl(13),ndmon_lp(13),nonleap,
     |   mon_cur,mon_nxt,ihr_cur,ihr_nxt,nointp=0
      real :: difsec,difday,sec,secint,dayint,
     |   z_curmo(nlon,nlat)=0.,z_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   tn_curmo(nlon,nlat)=0.,tn_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   un_curmo(nlon,nlat)=0.,un_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   vn_curmo(nlon,nlat)=0.,vn_nxtmo(nlon,nlat)=0.,	! UT interpolation
     |   z_tmp(nlon,nlat)=0.,tn_tmp(nlon,nlat)=0.,	! tmp 
     |   un_tmp(nlon,nlat)=0.,vn_tmp(nlon,nlat)=0.	! tmp 

!   
! Data: GSWM data given at the middle of each month 
!       -> day of year for this data assuming non-leap year
!         J  F  M  A   M   J   J   A   S   O   N   D   J
      data ndmon_nl                                ! non_leap
     |  /15,46,74,105,135,166,196,227,258,288,319,349,380/ 
! 
! External:
      real,external :: finterp
!
      if (iprint > 0) then
        write(6,"(/,72('-'))")
        write(6,"('GETGSWMNMISDI: get nonmigrating semidiurnal tidal ',
     |     'perturbation from database:')")
        write(6,"('Initial requested iyear=',i4,' iday=',i3,' iutsec=',
     |    i10)") iyear,iday,iutsec
      endif
! 
! Get month of model run
      do i = 1,13
        if(iday.le.ndmon_nl(i)) goto 10
      enddo
 10   mon_nxt = i		! next month
      if(mon_nxt == 13 ) mon_nxt = 1
      mon_cur = i-1		! current month
      if(mon_cur == 0 ) mon_cur = 12
! 
! Get hour of model run (model hours from 0 to 23 )
      ihr_cur = modeltime(2)	! current hour
      ihr_nxt = modeltime(2)+1  ! next hour
      if(ihr_nxt == 24 ) ihr_nxt = 1
      
! 
! GSWM hourly data from 0 UT (i=1) to 23 UT (i=24) resp. 0 utsec  
!
! Check times:
!
      if (modeltime(3).lt.0.or.modeltime(3).gt.59) then
        write(6,"('>>> getgswmnmisdi: bad imin=',3i4)") modeltime(3)
        stop 'getgswmnmisdi'
      endif
      if (modeltime(4).lt.0.or.modeltime(4).gt.59) then
        write(6,"('>>> getgswmnmisdi: bad isec=',3i4)") modeltime(4)
        stop 'getgswmnmisdi'
      endif
      
! Interpolate to modeltime iutsec for each month: mon_cur mon_nxt
      
      if (iutsec==0) then      ! no interpolation
        z_curmo(:,:)  = gswm_nmisdi_z(:,:,mon_cur,ihr_cur+1)  ! current month
        tn_curmo(:,:) = gswm_nmisdi_tn(:,:,mon_cur,ihr_cur+1)
        un_curmo(:,:) = gswm_nmisdi_un(:,:,mon_cur,ihr_cur+1)
        vn_curmo(:,:) = gswm_nmisdi_vn(:,:,mon_cur,ihr_cur+1)
        z_nxtmo(:,:)  = gswm_nmisdi_z(:,:,mon_nxt,ihr_cur+1)  ! next month
        tn_nxtmo(:,:) = gswm_nmisdi_tn(:,:,mon_nxt,ihr_cur+1)
        un_nxtmo(:,:) = gswm_nmisdi_un(:,:,mon_nxt,ihr_cur+1)
        vn_nxtmo(:,:) = gswm_nmisdi_vn(:,:,mon_nxt,ihr_cur+1)
      else
        difsec = 60.*60. ! difference in sec between ihr_cur and ihr_nxt
        secint = float(modeltime(3)*60 + modeltime(4))	! interpolation time [sec]
	
        call timeliper_array(gswm_nmisdi_z(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_nmisdi_z(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,z_curmo,1)
        call timeliper_array(gswm_nmisdi_tn(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_nmisdi_tn(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,tn_curmo,1)
        call timeliper_array(gswm_nmisdi_un(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_nmisdi_un(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,un_curmo,1)
        call timeliper_array(gswm_nmisdi_vn(:,:,mon_cur,ihr_cur+1), ! cur. month
     |    gswm_nmisdi_vn(:,:,mon_cur,ihr_nxt+1),difsec,
     |    secint,vn_curmo,1)
        call timeliper_array(gswm_nmisdi_z(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_nmisdi_z(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,z_nxtmo,1)
        call timeliper_array(gswm_nmisdi_tn(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_nmisdi_tn(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,tn_nxtmo,1)
        call timeliper_array(gswm_nmisdi_un(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_nmisdi_un(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,un_nxtmo,1)
        call timeliper_array(gswm_nmisdi_vn(:,:,mon_nxt,ihr_cur+1), ! next month
     |    gswm_nmisdi_vn(:,:,mon_nxt,ihr_nxt+1),difsec,
     |    secint,vn_nxtmo,1)
      endif  
!
! Interpolate to modelday (iday)
! Check if interpolation is necessary
      nointp = 0 
      if(iday.eq.ndmon_nl(mon_cur)) then ! same day as cur. month
         nointp = 1 
         goto 20
      endif
      if(iday.eq.ndmon_nl(mon_nxt)) then ! same day as next month
         nointp = 2  
         goto 20
      endif
	  
! If interpolation is necessary calculated the time differences      
      if(mon_cur /= 12) then			       ! not December
        difday = ndmon_nl(mon_nxt)-ndmon_nl(mon_cur)   ! difference in days
        dayint = iday - ndmon_nl(mon_cur) ! difference to interpolation day
      else					       ! December wrap around
        difday = ndmon_nl(mon_cur+1)-ndmon_nl(mon_cur) ! difference in days
        if(iday.lt.ndmon_nl(mon_nxt)) then ! difference to interpolation day
           dayint = 365. - ndmon_nl(mon_cur)+  iday
        else
          dayint = iday - ndmon_nl(mon_cur)  
        endif
      endif
!  
 20   continue  	! if no interpolation is necessary (nointp /= 0)
 
      if (nointp==0) then      ! interpolation
        call timeliper_array(z_curmo,z_nxtmo,difday,dayint,
     |           z_tmp,1)
        call timeliper_array(tn_curmo,tn_nxtmo,difday,dayint,
     |           tn_tmp,1)
        call timeliper_array(un_curmo,un_nxtmo,difday,dayint,
     |           un_tmp,1)
        call timeliper_array(vn_curmo,vn_nxtmo,difday,dayint,
     |           vn_tmp,1)
      elseif(nointp == 1) then    ! no interpolation same day as current month
        znmisdi_gswm(3:74,:)  = z_curmo
	tnnmisdi_gswm(3:74,:) = tn_curmo
	unnmisdi_gswm(3:74,:) = un_curmo
	vnnmisdi_gswm(3:74,:) = vn_curmo
	goto 30
      elseif(nointp == 2) then    ! no interpolation same day as next month
        znmisdi_gswm(3:74,:)  = z_nxtmo
	tnnmisdi_gswm(3:74,:) = tn_nxtmo
	unnmisdi_gswm(3:74,:) = un_nxtmo
	vnnmisdi_gswm(3:74,:) = vn_nxtmo
	goto 30
      endif
!
      znmisdi_gswm(3:74,:)  =  z_tmp
      tnnmisdi_gswm(3:74,:) = tn_tmp
      unnmisdi_gswm(3:74,:) = un_tmp
      vnnmisdi_gswm(3:74,:) = vn_tmp
! periodic points
 30   znmisdi_gswm(1:2,:)   = z_tmp(71:72,:)
      tnnmisdi_gswm(1:2,:)  = tn_tmp(71:72,:)
      unnmisdi_gswm(1:2,:)  = un_tmp(71:72,:)
      vnnmisdi_gswm(1:2,:)  = vn_tmp(71:72,:)
      znmisdi_gswm(75:76,:) = z_tmp(1:2,:)
      tnnmisdi_gswm(75:76,:)= tn_tmp(1:2,:)
      unnmisdi_gswm(75:76,:)= un_tmp(1:2,:)
      vnnmisdi_gswm(75:76,:)= vn_tmp(1:2,:)
!      
      if (iprint > 0) then
        write(6,"('GSWM nonmigrating semidiurnal tidal pertubation ',
     |    'interpolated to date and time')")
      endif
      end subroutine getgswmnmisdi    
!-----------------------------------------------------------------------
      subroutine timeliper_array(d1,d2,difd1d2,difint,fout,
     |  iprnt)
c
c Interpolate from fields d1,d2  linearly to time difint
c   (d1 must be at 0 unit time), returning fout
c On input:
c   d1,d2   = the field (d1 at 0 unit, d2 at difd1d2 units)
c   difd1d2 = time difference [unit] between d1 & d2
c   difint  = time of interpolation [unit] (counted from d1=0 time)
c In output:
c   fout is defined at difint
c
! Args:
      integer,intent(in) :: iprnt
      real,intent(in)  :: difd1d2,difint,d1(nlon,nlat),d2(nlon,nlat)
      real,intent(out) :: fout(nlon,nlat)
!
! Local:
      integer :: i,j
      real :: frac0,difd1d2_inv
!
      fout = 0. ! initialize output      
!
! Interpolation:
! from data_cur/d1 to data_nxt/d2 the difference is in time difd1d2
!      
      difd1d2_inv = 1./difd1d2
      frac0 = difint*difd1d2_inv	! x(int)/[x(d2)-x(d1)]
 
! linear interpolation: special case x(d1) = 0    
!  fout = (d2-d1)*frac0 + d1 - (d2-d1)*difd1d2_inv*x(d1)
! (d2-d1)*difd1d2_inv*x(d1) = 0 since x(d1) = 0
      
      do i = 1,nlon
        do j = 1,nlat
          fout(i,j) = (d2(i,j)-d1(i,j))*frac0 + d1(i,j)
	enddo
      enddo
      
      end subroutine timeliper_array
      
      end module gswm_module

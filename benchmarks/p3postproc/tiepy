#!/usr/bin/env python3

import os
import inspect
import matplotlib.pyplot as plt
import xarray as xr
from getoptions import get_options
from plot_gen import plt_lat_lon, plt_lev_var, plt_lev_lon, plt_lev_lat, plt_lev_time, plt_lat_time
import numpy as np
def main():
    args = get_options()
    

    # Map plot types to their respective functions
    plot_functions = {
        'lat_lon': plt_lat_lon,
        'lev_var': plt_lev_var,
        'lev_lon': plt_lev_lon,
        'lev_lat': plt_lev_lat,
        'lev_time': plt_lev_time,
        'lat_time': plt_lat_time,
    }
    
    # Get the plotting function based on the user input plot type
    plot_function = plot_functions.get(args.plot_type)
    
    
    if plot_function:
        # Checking if a directory is provided in the arguments
        datasets = []
        if args.dir:
            files = sorted(os.listdir(args.dir)) 
            for file in files:
                if file.endswith('.nc') and (args.dataset_filter is None or args.dataset_filter in file):
                    file_path = os.path.join(args.dir, file)
                    datasets.append([xr.open_dataset(file_path), file]) #loading datasets to xarray

        # Check and validate the specified time argument
        if args.time: 
            available_times = set()  
            for ds, filename in datasets:
                times = ds['time'].values  
                available_times.update(times)
            if np.datetime64(args.time) not in available_times:
                raise ValueError(f"The specified time {args.time} is not available in the datasets. Available times are {available_times}")
            args.time = np.datetime64(args.time)

        # Check and validate the specified time argument
        if args.mtime:  
            available_mtimes = set()  
            for ds, filename in datasets:
                mtimes = [tuple(m) for m in ds['mtime'].values]  
                available_mtimes.update(mtimes)
            input_mtime = tuple(args.mtime)  
            if input_mtime not in available_mtimes:
                sorted_mtimes = sorted(list(available_mtimes))  
                raise ValueError(f"The specified mtime {args.mtime} is not available in the datasets. Available mtimes are {sorted_mtimes}")
            args.mtime = input_mtime

        # Build the arguments dictionary for the plotting function based on its signature
        function_args = {}
        for param in inspect.signature(plot_function).parameters.keys():
            if hasattr(args, param):
                function_args[param] = getattr(args, param)
            elif param == 'datasets':
                function_args['datasets'] = datasets
        
        # Call the plotting function with the constructed arguments
        plot_object = plot_function(**function_args)
        
        # Save the plot if an output format is specified
        if args.output_format:
            filename = f"output_plot.{args.output_format}"
            plt.savefig(filename, dpi=100, format=args.output_format, bbox_inches='tight', pad_inches=0.5)
            print(f"Plot saved as {filename}")
        else:
            plt.show()
    else:
        print(f"Invalid plot_type: {args.plot_type}")

if __name__ == "__main__":
    main()

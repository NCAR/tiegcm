

!======================================================================

Oct 04 -> May 05:

Development on tiegcm1.6 leading to tiegcm1.7, tiegcm1.8dev1, 
tiegcm1.8dev2, and the tiegcm1.8 "tuning release", dev/tiegcm1.8: 

!======================================================================



10/21/04: Changed #include statements from "file.h" to <file.h>.
Used perl /home/foster/tgcm/scripts/change_incs_bracks.

10/29/04:
Small change to print format statement in advance.F.
Fixed dispose.F to correct password problem in mscomment (see save/dispose.old)

!-----------------------------------------------------------------------

1/10/05:
Copied source from /home/tgcm/tiegcm1.6/src and scripts from ~/tgcm/scripts.
Modifying source for lightning linux cluster, like ~/tgcm/timegcm/src.
This is currently not a CVS working directory -- CVS working directory
is ~/tiegcm/tiegcm, but this dir (from /home/tgcm/tiegcm/src) is more
up to date. At some point (when code is working on lightning), this
should become the CVS working dir.

1/10/05:
Removed nc_xxxx routines from nchist.F, replacing them with the netcdf
functions nf_xxxx. The routine nc_get_var_real (nf_get_var_double) was
being used incorrectly (getting scalar when var is a vector with time
dimension). Now using nf_get_var1_double to get scalar at time itime. 
(see, e.g., reading f107a, f107d, etc). Same for ints that are dimensioned
in time.

1/11/05:
Determined that -fastsse does not work for dynamo (problem w/ rhs).
So mpif90 optimization should be -O2 -fast.

1/12/05:
Cleaning up for lighting: added shutdown routine (util.F), and several
other routines in util.F. Changed output, nchist, etc so that disk
file names can be used for SOURCE, OUTPUT, or SECOUT.

Changed some dimensions to avoid out-of-bounds check by the compiler.
Can now use -g -C to check for out-of-bounds. (see esp, dynamo.F, where
array() was changed to wkarray(), and put in module data).

Removed "old" dynamo option (dynamo_old.F). Now the namelist read parameter
DYNAMO <= 0 -> no dynamo, or
DYNAMO >  0 -> dynamo ("new" only)

tempdir can now be blank (which has same effect as tempdir==.).

2/2/05: This is now a CVS working directory for project tiegcm,
including scripts and src directories. Repository is /home/tgcm/cvs/tiegcm.

Feb, 2005: Rewrote timing module, as in timegcm1.2. See timing.F, and
calls in advance.F and dynamics.F.

2/10/05: Copied updated scripts from ~foster/tgcm/scripts to ~foster/tgcmtiegcm/scripts.

2/10-11/05: Verified that results are the same as 1.6: got 0 diffs between
1.6 and 1.7 runs on the same platform, and near-zero (1.e-5) diffs between
platforms.

2/11/05: Committing to CVS repository, and tagging as tiegcm1-7.

!-----------------------------------------------------------------------

Changes from tiegcm1.7 to tiegcm1.8:

2/28/05: Using k instead of k+1 in mbar calculation in dt.F.

3/18/05: 
Added check_nans, see util.F and nchist.F. Finding nans when
writing prognostic fields is fatal, see nanfatal in nchist.F.  

Putting read of magfield data file back in for use only when
dynamo==0 (was crashing on lightning). See tgcm.F and magfield.F.

Swapped loop order for efficiency near top of sub nodynamo (dynamo.F).

3/28/05:
Merged Astrid's mods to dynamo (/callisto/i/maute/teTex.d/merge_w1.7).
This included 2 new source files: highlatpoten.F and magpres_g.F.
Extensive changes to dynamo.F, current.F, apex.F.

4/4/05 btf:
Added gswm options to bndry.F, addiag.F, dt.F, and duv.F. This eliminates
source files bndry_gswm.F, addiag_gswm.F, dt_gswm.F, and duv_gswm.F.
Did "cvs remove" on the eliminated files. This will take effect with
the next cvs commit.
Also consolidated gswm calls from advance.F to sub getgswm in gswm.F.
Also changed gswm flags and file names for non-migrating tides
(i.e., gswmnmidi and gswmnmisdi changed to gswmnmdi and gswmnmsdi).

4/6/05:
CVS tagged code with "cvs -q tag tiegcm1-7+gswm+maute".
I.e., mods to tiegcm1-7 so far, including gswm and maute mods,
but prior to merging lqian code.

4/6/05:
Merged Liying's mods (lqian/):
Mods to: aurora.F, chemrates.F, dynamics.F, init.F, input.F, newton.F,
qinite.F, qrj.F, tgcm.F, util.F. Removed files xray.F and qtieff.F,
and added new source file soldata.F. There is a new namelist parameter
SD_NCFILE, specifying SEE data netcdf file. The default SEE data file
is $TGCMDATA/see__L3_merged_2005007_007.nc. 

Added this default file to scripts/MkNamelist for tiegcm (commented out). 
Also added copy of this file to exec dir by scripts/tgcm_config. The new 
MkNamelist and tgcm_config were distributed to model scripts directories 
at both hao and scd.

Added new global file attribute for sd_ncfile to histories (nchist.F).
If sd_ncfile is not in use, the attribute value is "[none]".

Commented many addfsech calls (mostly in maute code dynamo, hightlat*, 
magpres*, etc.)

CVS tagged code with "cvs -q tag tiegcm1-7+gswm+maute+lqian", but this
turned out to be incorrect -- it tags the current repository, not the
working directory from which the tag command is given. One must do a
commit, *then* save a tag.  Consequently, we do not have a version from 
after maute dynamo mods but before lqian qrj and SEE data mods.

Broke init_fields (fields.F) into 2 routines: init_4d and init_3d.
This allows compilation on certain flavors of pgf90 (e.g., on HAO Callisto)
Changes to fields.F and init.F.

4/7/05:
Doing a cvs commit, and tagging as tiegcm1-8dev1: this is leading up
to a pre-release of tiegcm1-8. This code is essentially tiegcm1-7 plus 
the following:
  -- maute dynamo mods
  -- lqian euv/qrj and SEE data option
  -- foster gswm mods (combine dt.F and dt_gswm.F, etc.)

4/19-20/05:
Copied Liying's new ~lqian/aurora.F, with qtef fix. This was causing
problems on lightning with 8 processors.

4/21/05: Made 2 10-day runs, one with periodic points and boundary
longitudes set in dt.F, and one without. Making these calls was
recommended by Wenbin (see ~foster/tgcm/tiegcm/doc/wenbin). However,
there were zero differences in all major fields after 10 days,
according to tgcmproc_f90. 

Uncommented mp_bndlons_f3d and mp_periodic_f3d in dt.F, as per
Wenbin's request.

4/22/05: 
Saving this code as "tiegcm1.8dev2", CVS tag "tiegcm1-8dev2".

Executed:
cvs commit -m "tag tiegcm1-8dev2: dynamo currents and high-latitude options, new EUV/qrj parameterization, Timed SEE data option, updated chemrates"

cvs tag tiegcm1-8dev2
!-----------------------------------------------------------------------

5/3/05:
Added sub expand_path in util.F, called by getfile, so user can imbed
env vars in file paths (e.g. in SOURCE, GPI_FILE, etc). E.g.:

 SOURCE='$TGCMDATA/TGCM.tiegcm.p001-2002-080.nc'
 SOURCE='$MYDIR/FOSTER.tiegcm1.8.peqnx_001.nc'
 SOURCE='/hao/$MYSUBDIR/FOSTER.tiegcm1.8.peqnx_001.nc'
 SOURCE='$MYDIR/$MYSUBDIR/FOSTER.tiegcm1.8.peqnx_001.nc'
 SOURCE='/TGCM/data/TGCM.tiegcm.p001-2002-080.nc'

Note expand_path is recursive, so multiple env vars can be imbedded in
the path, as in example 4 above. If a '$' is not found in the path,
expand_path simply returns without changing path, e.g., in the last
example above.

Committing this to CVS, and giving it to Ray for tuning prior to
the "pre-release" to hao AIM. This model is saved in
$TGCMROOT/dev/tiegcm1.8/ at both hao and scd.

5/5/05: Ray says this is ok for tuning release. Tagging as tiegcm1-8tune.
Source is in $TGCMDATA/dev/tiegcm1.8/ (HAO and SCD). Also tar file is
/toshi/ftp/pub/tgcm/tar/tiegcm1.8tune.tar.

5/5/05: Allow "/TGCM/" to be an mspath (in addition to "/LOGNAME/" in 
function is_mspath (util.F)

Enable env var to be included in file path names, e.g.,
SOURCE = '$TGCMDATA/...'

5/11/05: Removed mpi_barrier call in putms to prevent job from hanging
when DISPOSE=1 (putms is called by master task only).

5/12/05: Preparing tiegcm1.8 "tuning release", see doc/README_1.8tune
CVS tag will be tiegcm1.8tune, source in $TGCMROOT/dev/tiegcm1.8.

!-----------------------------------------------------------------------
Mods after tiegcm1.8 tuning release (i.e., after 3:30 pm, May 12, 2005):

5/12/05: Fixed function b_search (util.F) to compile on SGI tempest.

5/27/05: Copied new soldata.F and util.F from Liying, so shutdown is
called if model date/time are not found in available SEE data.
(I changed function name real_bsearch to int_bsearch in util.F,
but this was later changed to b_search on 7/28)

Also, put int dummy declaration before inarray declaration in both
int_bsearch and long_bsearch, for the SGI compiler (as in 5/12 above).

7/8/05: Changed length of line read by sub rmcomments (util.F) from 
80 to 6400, so namelist read lines in .inp file can be long (thanks to 
Cedric St-Jean).

7/20/05: In soldata.F, changed 
  include "netcdf.inc" to 
  include <netcdf.inc>

7/21/05: Fix function my_msrcp so only master MPI task does msrcp command.

7/28-29/05: Demerged first attempts to remove storing t,u,v lbc in top
slot. This was premature. Saved this version of cvs working directory
in /e/foster/tiegcm/tiegcm-mywrk. Then merged in the above changes, since
5/12, and included Astrid's mods for new lamdas, qjoule (which were
saved as tiegcm1-8tune1 earlier this week).

Also saving several minor changes in scripts (updated gpi and ncep files
in tgcm_config and MkNamelist, added SEE data file, removed dave and
blackforest from some job scripts (they were still in repos versions,
new locations for lightning netcdf libs,etc).

7/29/05: Made default test runs on callisto (hao), bluesky, lightning,
and tempest.  Doing cvs commit, and tagging this as tiegcm1-8tune2.

7/25/07: am
rewritten lamdas.F; correct Joule heating for ions qjoule.F; include vertical 
velocity difference for Joule heating calculation which goes into neutrals 
qjoule.F

9/22/05: Updated apex_subs.F from Astrid -- this has new apex coefficients
for 1995, 2000, 2005.. Copied her file from /home/maute/apex.d/modsrc_apexmod.

Also improved expand_path (util.F) for expanding env vars used in
file specs in namelist read. 

1/18/06: 
  Fix "mgr bug" in oplus 
  Reference lev1 (rather than lev0) for tn lbc in comp.F, because lbc is
    still in top slot.

Doing cvs commit to update these 2 changes and the new apex.F. 

#-----------------------------------------------------------------------
4/2/07: See dynamo mod by Astrid, in ../consult/astrid.dynamo.
See also $TGCMROOT/tiegcm1.8/src/modsrc/dynamo.F and README.

8/13/07 btf:
Changed init of dynpot lons from nlonp4 to nlonp1 in sub set_dynpot
(rdsource.F) because dynpot is dimensioned nlonp1 (fields.F). This
subroutine is called only for non-mpi serial runs. This was pointed
out by George Millward.

!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
10/23/07  am
  Minor correction to dynamo.F, pointed out by Wenbin:
  dynamo.F: line 843-844
  correct the hemispherical adjustment of the high latitude electric potential
  This adjustment is done for asymmetric high latitude potential pattern for
  HEELIS and Weimer (not working at the moment).
  Therefore, fac = 1 (line 842)
  Heelis pattern is hemispherically symmetric, therfore 
  phihm(i,southH_n)-phihm(i,northH_n) = 0
  For modified Heelis (mod_heelis=.true.), we don't want this correction, 
  since it's symmetric anyway,
  therefore fac = 0.

  This was an error in the code, but since we had only hemispherically 
  symmetric potential pattern, we didn't get wrong results.

10/25/07 am
  modifications to use directly the calculated electric field from 
  the electrodynamo part instead of starting from the electric potential
  in efield.F.
  NOTE: mpi is done for each field separately instead of combining the
    field and then do one passing (see ).

10/25/07 btf
Updated scripts directory from hao:$TGCMROOT/tiegcm1.8/scripts and commit

11/7/07 btf: Changed use-assoc from params module in heelis.F to avoid
conflict w/ dummy args. This is for the IRIX compiler (it was not a 
problem under AIX).

!--------------------------------------------------------------------------
11/7/07 btf:
Begin major revision to use history mechanism and other improvements from 
tiegcm-hist-lbc, but retain 97 km lbc.

11/9/07 btf: Many changes, including copying several files from tiegcm-hist-lbc
model (nchist.F, output.F, hist.F, etc). This code runs but produces bad output
(NaNs, 0's, etc).  The "top slot" convention for t,u,v has not yet been removed. 
Saved this as tiegcm_runs1.tar. This code has removed addfsech, and has addfld, 
but the addfsech calls have not yet been converted to addfld calls.

11/14/07: Is running now and results look ok. "Top slot" convention has been
removed. Removed OX and O3, and 3d fields gswm_rfu,rfv, eddy, vo3, sco3, o1d.
Am now completing conversion of addfsech calls to addfld.

Had to set mxlev==ilev1==nlevp1 in mp_gather2root_sech in mpi.F because
nmlev > nlevp1 because of extra levels below lbc in dynamo.

11/19/07: Added Astrid's electric field calcs in dynamo, w/ changes to efield.
Now emx,emy,emz are calculated in efield only in first timestep, then efield is
calculated in dynamo as emphi3d, emlam3d, and ez3d, and copied to emx,y,z in
efield.

11/20/07: All addfsech calls are now converted to addfld.
Saved /oreo/d/foster/tiegcm/tiegcm1.81.tar

11/26/07: Have now made a full year 2002 run w/ this code. All primary files,
and selected secondary files, w/ utproc plots are in /aim/d/tgcm/tiegcm1.81_yr02.

Now preparing to do a commit, and will save tag tiegcm1-81. 
This code does *not* include most of the mods from $TGCMROOT/tiegcm1.8/src/modsrc.
Will notify the "dev" group about this commit, and suggest a meeting
to decide next steps, like including changes from tiegcm1.8/src/modsrc.

--------------------------------------------------------------------------------
1/7/08: Changes to 1.81, toward 1.82:

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
aurora.F
  - ed reduced from 0.5 to 0.11 (Gang Lu mod from July 28, 2006)

> ! 8/1/06 btf: change conditional as per Richmond suggestion:
> !     if (power >= 0.01) plevel = 2.09*alog(power)
>       if (power >= 1.00) plevel = 2.09*alog(power)

> !      e1 = (0.5 + 0.15 * power)
> !      e2 = (1.5 + 0.25 * power)
> ! modified by LQIAN, 2007
> ! produce realistic oval compared to NOAA empirical auroral oval and TIMED/GUVI
> ! e1 formula given by Wenbin base on POLARVIS image;
> ! e2 formula based on Emery et al original auroral parameterization report
>       e1 = max(0.50, -2.15 + 0.62*plevel)
>       e2=1.+0.11*power

> !      h1 = 2. + 0.05 * power
> !      h2 = 3. + 0.20 * power
> ! modified by LQIAN, 2007
> ! produce realistic oval compared to NOAA empirical auroral oval and TIMED/GUVI
> ! h1 formula given by Wenbin base on POLARVIS image;
> ! h2 formula based on Emery et al original auroral parameterization report
>       h1 = min(2.35, 0.83 + 0.33*plevel)
>       h2=2.5+0.025*max(power,55.)+0.01*min(0.,power-55.)

> !     alfa_1 = 2. 
>       alfa_1 = 1.5

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
duv.F
> #else
> !
> ! Set periodic points for serial run:
>       ztmp(:,1:2,:) = ztmp(:,lonend-2:lonend-1,:)
>       ztmp(:,lonend+1:lonend+2,:) = ztmp(:,3:4,:)

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
gpi.F

322,324d321
< ! Set minimum hemispheric power to 3 gw:
<         if (ipower > 0) power = max(3.,-2.78+9.33*fkp)
< !
326c323,337
<         if (ictpoten > 0) ctpoten = 29.+11.*fkp
---
> ! modified by LQIAN, 2007
> ! formula given by Wenbin based on data fitting
>         if (ictpoten > 0) ctpoten = 15.+15.*fkp + 0.8*fkp**2
> !
> ! Formula for hemispheric power:
> ! modified by LQIAN, 2007
> ! for fkp<=7: formula given by Zhang Yongliang based on TIMED/GUVI
> ! for fkp>7: power is 153.13 when fkp=7 from Zhang's formula, 
> ! assume power is 300.(based on NOAA satellites) when fkp=9 
> ! do linear interporation in between
>         if (ipower > 0)  then
>             if (fkp <=7.) power = 16.82*exp(0.32*fkp)-4.86
>             if (fkp > 7.) power = 153.13 + 
>      |                            (fkp-7.)/(9.-7.)*(300.-153.13)
>         endif
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
lamdas.F

237a238,247
> !
> ! 6/2/06 btf: Multiply rnu_ne by 4, as per Richmond:
> !
> ! The effective electron-neutral collision frequency is increased in 
> ! an an hoc manner by a factor of 4 in order for the model to produce
> ! electric fields and currents below 105 km that agree better with
> ! observations, as recommended by Gagnepain et al. (J. Atmos. Terr. 
> ! Phys., 39, 1119-1124, 1977).
> !
>       rnu_ne = rnu_ne*4.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
magfield.F

455c455
<           decmag(i+2,j) = -atan2(yb(i,j),xb(i,j))
---
>           decmag(i+2,j) = atan2(yb(i,j),xb(i,j))
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
qrj.F
 - Liying changes to ssflux call (wave1,wave2,sflux), and data initialization
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
soldata.F
228c228
<       integer,external::b_search
---
>       integer,external::real_bsearch
235c235,239
<       iyfrac=iyear+(iday-1+(iuttime/24.))/365.
---
>       if (mod(iyear,4) == 0) then
>          iyfrac=iyear+(iday-1+(iuttime/24.))/366.
>       else
>          iyfrac=iyear+(iday-1+(iuttime/24.))/365.
>       endif
250c254
<       index=b_search(yfrac(:,istruct),1,ndate,iyfrac)
---
>       index=real_bsearch(yfrac(:,istruct),1,ndate,iyfrac)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
util.F
 Added Liying functions: 
      integer function real_bsearch(inarray,first,last,key)
      integer function long_bsearch(inarray,first,last,key)
      integer function int_bsearch(inarray,first,last,key)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

1/7/08: Added #if conditionals around dipmin parameter, see cons.F and magfields.F.

1/8/08: Changed filtering mechanism to the simpler method used in timegcm,
i.e., #if to set kut in cons according to horizontal resolution. Removed
sub set_wave_filter. Added option to call filter and/or filter2 in oplus.
S.a. changes to sub filter in filter.F.

1/8/08: Model now runs at double resolution, but timestep must be reduced
to 60 seconds. Blueice took almost 1/2 hour to make a 1-day run at 60 sec
step (ave 1.16 secs/step) with 32 processors (dynamo used 44% of wallclock!)

1/11/08: Doing cvs commit and tagging as tiegcm1-82. (version name in params.F
changed from 1.81 to 1.82).

--------------------------------------------------------------------------------
1/14/08: Changed format of "Elapsed run time" in sub timer_report (timing.F).

1/24/08 btf: mods from Astrid:
am 1/22/08 (qinite.F, elden.F)
  change the flux in qinite
  from
        real,parameter :: al(3) = (/5.E4, 5.E3, 5.E3/)
  to     
        real,parameter :: al(3)=(/0.75E7,0.75E6,0.75E6/)
  The new triple values are from TIME-GCM.
  In addition remove the minimum electron density in elden.F
 
  Motivation:    
  the usage of the minimum electron density in elden.F was not consistent
  with the later ion calculation,
  and was leading to an unbalance in electrons and ions.
  It was decided that having a minimum electron density shouldn't
  be necessary if we have a better nighttime ionosphere. However,
  implementing formulations like Titheridge suggested was postponed for
  later. We looked at this a few years ago, and it wasn't straight forward to
  implement. So increasing the night time flux of the three lines (1026,304,584)
  seems reasonable, also TIME-GCM is using the same values.
  The nighttime NE at plev=-2 is around log(Ne)=3.2 at low latitudes. The
  prereversal enhancement is decreasing a bit (around 3-4 m/s) at JRO.

1/24/08 btf: aurora mods from Wenbin:
      EC=(0.24+0.0067*HP)/5   ! wb version
      ALFAC=0.1                                                             TAIL.114
      ED=0.0012+0.0006*HP  ! wb version
      ALFAD=0.50       ! wb version                                       TAIL.116

Added the following auroral parameters to the histories (single dimension in time,
see nchist.F)
     |    e1,e2,             ! peak auroral energy flux
     |    h1,h2,             ! gaussian half-width for aurora
     |    alfac,ec,          ! aurora cusp energy
     |    alfad,ed,          ! aurora drizzle energy

Removed alfa30,e30,alfad2,ed2 from the history (timegcm only)

Small change to print of timing results at end of program (sub timer_report
in timing.F)

Will remake tiegcm1-82 (including the cvs tag) with these changes.

1/30/08: Fixed path to double res tiegcm source file in Mknamelist.
Redo cvs commit and retag tiegcm1-82.
--------------------------------------------------------------------------------

2/1/08: Made a year-long 2002 run of tiegcm1-82, see /aim/d/tgcm/tiegcm1-82_yr02.

2/21/08: Roble and Foster present results of tiegcm1-82 year 2002 run,
including emperical model comparisons, generated by empproc f90 processor.

3/12/08:
Added $mss option to tgcm_config and job scripts. This can be either 
"TRUE" or "FALSE", indicating availability of the NCAR MSS. This is 
added to top of the Makefile by tgcm_config, and -DMSS set or not set 
accordingly.  Removed references to get_diskfile (rdsource.F and magfield.F).
Tested with and without mss on blueice.

3/12/08:
Allow Weimer model wei01gcm.F to be called (namelist read parameter 
"potential_model", and if so, force one of byimf,bzimf to be non-zero 
(see input.F). This appears to be working.

Added option for user to provide time-dependent byimf, bzimf, swden, 
swvel, and al in namelist read file. This is similiar to ctpoten and 
hpower. Also added these to the histories.

3/28/08:
Completed new full year run of tiegcm1.82 for 2002, saving hourly
secondary histories for the entire year. Documentation (but not history 
files) is in /aim/d/tgcm/tiegcm1-82_yr02c.  There were no mods (all 
source in $TGCMDATA/tiegcm1-82).

4/2/08: 
Introducing Weimer 2005 model for electric potential. There are two
new source files: w05sc.F and w05sc_rddat.F. Translation from original
IDL (obtained from Dan Weimer) to f90 was done in /oreo/d/foster/weimer05.
His original IDL data files were translated from xdr to ascii
(see /oreo/d/foster/weimer05/xdr_to_dat). They are now in $TGCMDATA.
(see w05sc_path in input.F). Now the namelist read potential_model
can be "NONE","HEELIS","WEIMER01", or "WEIMER05". 

Next steps will be to translate field-aligned current part of Weimer
2005 model, and write a netcdf file instead of using the ascii data files.

Added "indices_interp" to namelist read to indicate whether or not
time-dependent indices provided should be interpolated to model time.
Default is 1, so if the user sets indices_interp=0, then the indices
are changed only according to the given time-dependent values (this
way step functions can be used).

Between 4/2 and 4/16: Translated MPFAC and related procedures from IDL 
to f90. The w05sc module calls it so now the FAC field-aligned current 
is available as w05sc_fac(nmlonp1,nmlat) in the w05sc module (w05sc.F).

Made test runs of weimer05 with bz varying from -10 to +10. Made animations
of epot and fac for the group to evaluate, 
see /oreo/d/foster/tiegcm/weimer05/animations/w05sc
GIF animations were also saved in /toshi/ftp/pub/tgcm/tiegcm1-82/weimer05vs01.
Gang says weimer01 is not working, and weimer05 is ok, so can now remove
weimer01 option (but have not done this yet).

4/16/08:
Made netcdf data file w05sc.nc from .dat files (which were made from the
original idl .xdr save files). See /oreo/d/foster/weimer05/dat_to_nc.
The netcdf file is now read at 1st timestep by sub weimer05 (w05sc.F).
w05sc_rddat.F was eliminated, since the .dat files are no longer read.
The $TGCMDATA/*.dat files can be eliminated later, when nobody is using
the previous version (which was saved as a tar file in 
/oreo/d/foster/tiegcm/weimer05) for Liying, Wenbin, etc.

Copied weimer05 related source code used to translate from IDL to f90,
and making .dat and .nc data files, from /oreo/d/foster/weimer05 to
~/tgcm/weimer05 as backup.

Removed typedef inp from input.F, as it was never used.

Segregated "nodynamo" routines (called when DYNAMO=0) into nodynamo.F
(module nodynamo). This avoid confusion when working w/ the dynamo code.
Also removed Astrid's BOP documentation.

4/17/08:
Removed calls to ilink (util.F), so imported data files are not linked
from another location or to another name (see getfile, putms, output,
etc). Also, namelist read tempdir is now deprecated. Having it in the
input file will result in a non-fatal warning from input.F.

Increased mxlen_filename in input.F from 80 to 240.

Added "gale" section to Makefile and tgcm_config so now code builds
under ifort on gale.scd.ucar.edu, however it is mysteriously seg-faulting
at first call to rdgswm in gswm.F (sub getgswm). Print statement before
call to rdgswm shows, but first exec statement print in rdgswm does not
print. Asked Sid about this. Small test program works. Tried gdb, but
got almost nowhere. Will give this up for now. Identical code runs fine
on hao linux, blueice, lightning, tempest.

4/21/08:
Simplified scripts/Makefile, some minor changes to tgcm_config, and
tested on blueice, lightning, oreo, tempest, and gale. Had to make 
small change to use-assoc of mpi in hdif.F for tempest compiler.
Still have seg fault problem on gale as mentioned above.

Moved doc directory to ~foster/tiegcm/doc.

4/25/08:
Going back to HEELIS as default potential_model (input.F).

4/25/08:
Wenbin's fix to periodic points in duv.F, see comments and calls at 
end of sub glp.

Changed scripts/Mknamelist to use $TGCMDATA/FOSTER.tiegcm1-82.py2s004.nc
at 80,0,0 as SOURCE history in default namelist input file. Also set 
CALENDAR_ADVANCE=1.  When tiegcm1.9 is released, will put new source 
histories on $TGCMDATA for use by this version. 

Changed "w05sc" to "wei05sc" throughout, for better clarity.
This includes wei05sc_ncfile. Copied $TGCMDATA/w05sc.nc to wei05sc.nc.

Replaced ZBOT,ZTOP with  ZIBOT,ZITOP,ZMBOT,ZMTOP in src/defs.h so 
it can be used without being written by tgcm_config

Changed tgcm_version from tiegcm1-82 to tiegcm1-83 in params.F.

4/28/08: Preparing for cvs commit and tag as tiegcm1-83.
--------------------------------------------------------------------------------

4/30-5/1/08:
Removed sub bndry_annual and related zba,tba,uba,vba. This involved changes to
bndry.F, addiag.F, advance.F, dt.F, duv.F, cons.F. Introduced new constant
zbound as lower boundary background Z (cons.F). This is added to the tidal 
perturbations in Z (addiag.F). Zbound takes the place of ZBA=CC(0,0)*1./RT2*1.e5, 
which was set in bndry_annual, even when TIDEANN was 0. 

Tested against 1-83 with gswm migrating (TIDE==0), and with TIDE,TIDE2 set 
(no gswm).  Tgcmproc reported 0 diffs in both cases, so it appears to be
working.

Print warning and shutdown if input reads a non-ispval value > 0 for namelist 
read parameter TIDEANN. No action is taken if TIDEANN=0.,0.  to support use of 
old namelist read files. Did the same for TIDE3M3 (no 2-day wave in tiegcm).

Removed TIDE3M3 and gswm non-migrating files from tiegcm default namelist read 
file (Mknamelist).

Reset format of prints of certain history vars (bzimf, etc), so they come
out e12.4 instead of ***** when they are spval (sub hist_print in hist.F).

Went back to mxlen_filename = 80, because the 240 setting (changed in 1-83)
was causing problems reading source histories. All paths to input data files
(gpi, see, gswm, etc) must be <= 80 chars in length.

5/1/08: Preparing a cvs commit, but will not make new tag at this time.

5/12/08: Fixed wei05sc.F to call setmodel with correct angle by/bz for 
different hemispheres (change sign), as per Barb (see bt, angle, and setmodel 
and setboundary calls)

5/12/08: Remove use-assoc of freq_ann from cons.F by bndry.F (freq_ann is
no longer in cons, since annual tide was removed from the code).

5/13/08: Save local tablesize in function scplm (wei05sc.F). This bug was
pointed out by Tomoko (Dan Weimer gave her my f90 translated code to use).

5/14/08: Doing cvs commit of wei05sc.F, bndry.F, and README to save the
above 3 changes. No new tag. 

5/27/08:
Sub mp_gather2root_sechist in mpi.F was improperly referencing ilon0,ilon1 
and ilat0,ilat1 in the send and receive buffers (sndbuf and rcvbuf). Fixed 
this to use nlons and nlats, similiar to sub mp_gather2root_prim. This bug 
was apparently introduced in November, 2005, when mp_gather2root_sechist was 
rewritten for the addfld method. See also ~/tgcm/timegcm/src/mpi.F.

5/28/08: Errors were coming out of sub def_sech (nchist.F) when starting 
secondary histories after start time (i.e. SECSTART > START). Fixed this 
by adding nf_inq_varid to see if the var is already defined. 

Some other minor changes to stdout, print statements, etc (bndry.F, nchist.F,
output.F)

5/28/08: Doing cvs commit, but still no new tag.

6/11-12/08: 
Am copying modsrc.imf files to src (i.e., Weimer05 plus imf data option), 
and removing modsrc.imf dir. Making some additional minor mods (see below), 
prior to saving 1-84 tag.  After some testing, code will then be committed 
and frozen as tiegcm1.9. This was approved by the tiegcm development group 
in our meeting today.

The current state of src (before copying modsrc.imf to src), including 
modsrc.imf subdir (with README) is saved in /oreo/d/foster/tiegcm/tiegcm1-83_imf.tar.gz. 
This is the code (including the modsrc.imf mods) that was saved as tiegcm_imf 
"internal release" $TGCMROOT/tiegcm_imf/src plus additional mods in src/modsrc, 
and was used to make the 5 test runs of Weimer05 with imf data, results of which 
are saved in /toshi/ftp/pub/tgcm/tiegcm1-83/tiegcm_imf.

Changes to src after incorporating mods from modsrc.imf (and removing modsrc.imf):

Added local parameter joulefac=1.5 in dt.F, to replace the hardwired 1.5 constant.

Made some changes to the default namelist input file generated by Mknamelist.
(added Weimer05, imf parameters, step=120 instead of 180, some comments, etc)

Changed version string to tiegcm1-84 (params.F).

Removed mag(2,2) namelist parameter (location of mag poles)

Removed DYNAMO=0 option. Removed source file nodynamo.F. Dynamo flag
is still in namelist read, but model stops if it is set to 0.
Also removed read of magvol file, and the magvol namelist parameter.
Removed subs and call in magfield related to reading the magvol file.

6/13/08:
- Added $lib_netcdf and $inc_netcdf to job scripts (passed to tgcm_config)
- Other minor changes to job scripts and Mknamelist (default namelist file) 

6/13/08: Preparing to cvs commit and save tag tiegcm1-84.

6/16/08: 
Added the following academic license reference at top of each source file:
!
! This software is part of the NCAR TIE-GCM.  Use is governed by the 
! Open Source Academic Research License Agreement contained in the file 
! tiegcmlicense.txt.
!
File tiegcmlicense.txt is new, and will be added to the cvs repository
in the src directory.

6/18/08: Added Dan Weimer intellectual property statement at top of wei05sc.F,
along w/ the academic license reference.

>>>>>>>>>>>>>>>>>>  Commit and release of tiegcm1.9 <<<<<<<<<<<<<<<<<<<
6/20/08:
cvs commit -F commit_notes/tiegcm1.9 
cvs tag tiegcm1-9

=============================================================================
am 8/7/08
  for the calculation of J_e2 there was an inconsistency
  because J_pg was added to J_e1 but not J_e2
  (only for output - for the dynamo equation both components
  were added) have to use icalkqlam=1 flag.
  files: dynamo.F
         current.F
----------------------------------------------------------------------
8/25/08 btf:
Added initial_day attribute to the time variable.
See hist.F and nchist.F.

----------------------------------------------------------------------
8/29/08:
Revised gswm.F for intel compiler on gale: nf_get_var_double does not
work when array subsection is passed, e.g. the following seg faults on
gale (but works fine under xlf and pgf90):

      real,dimension(nlonp4,nlat,nmonth,nhour) :: t,u,v,z
      istat = nf_get_var_double(ncid,idv_z,z(3:nlon+2,:,:,:))

This was replaced with the following, which works on gale:

      real,dimension(nlonp4,nlat,nmonth,nhour) :: t,u,v,z
      real,dimension(nlon,nlat,nmonth,nhour) :: tmp
      istat = nf_get_var_double(ncid,idv_z,tmp)
      z(3:nlon+2,:,:,:) = tmp(:,:,:,:)

----------------------------------------------------------------------
9/3/08 btf:
Fixed commented addfld calls for 2d fields in advance after dynamics call.
The fix was that the fields must specify (lon0:lon1,lat0:lat1), e.g.:

!     call addfld ('CUSP','2D CUSP','0-1',
!    |  cusp2d(lon0:lon1,lat0:lat1),'lon',lon0,lon1,'lat',lat0,lat1,0)

----------------------------------------------------------------------
9/5/08 btf:
Add logical function ismissing (imf.F) for use reading imf data.

----------------------------------------------------------------------
9/10/08 btf:
Barb's new sub wei05loc in wei05sc.F to position the aurora wrt Weimer
2005 potential. See test runs in download.hao.ucar.edu/pub/tgcm/tiegcm1.9_w05loc
(this is linked from the wiki). Tiegcm dev group meeting today approved
this mod.

Mods to better detect missing data in imf.F.

----------------------------------------------------------------------
9/17/08 btf:
Added option for asychronous msrcp in putms.F, but not activating
it yet, since cannot call dcswait or dcsq without linking the dcs lib.

10/11/08 btf:
Removed sub defvar_f3d from nchist.F, since it is not called.

10/29/08 btf:
Realized that source history structure sh was not being written to the 
first history of an initial run (the fields data, which is not part of
the history struct, was being copied correctly). To fix this, added 
subroutine copyhist in hist.F. This is used to copy sh into h (instead of 
calling define_hist) then call nc_define (which writes h to the file). 
See output.F.

----------------------------------------------------------------------
10/31/08 btf:
Fixed error print statement re rdays in nchist.F (see line 2584).

Fixed defs.h in commented-out section of vres=0.25:

!#define ZMBOT (-6.875)
!#define ZMTOP (7.125)

(they were -6.75 and 7.25). tgcm_config does set these correctly
when vres=0.25 is passed, but they should be fixed in the default
defs.h, even tho they are commented-out, in case people change
defs.h manually and don't notice they are wrong.

----------------------------------------------------------------------
11/4/08 btf:
If model day mtime(1) > 365, then write model day mtime(1)-365 to the
output history. E.g., if a run is made to day 366 (i.e., Jan 1 of
the next year), in preparation for an initial run starting Jan 1,
it will be written to output as model day 1 (mtime 1,0,0), and can
be used as a source history for the initial run starting Jan 1.

11/7/08 btf: TO DO: set trap and error message if SOURCE is a
secondary history. This should be done in sub nc_rdhist (nchist.F),
using the global file attribute "history_type". Currently, if a
secondary history is used, the model will seg fault (Wenbin experienced
this). 

----------------------------------------------------------------------
12/2/08 btf:
Mods to aurora.F from Wenbin, Barb, and Liying. Explanation from Wenbin:

Four things have been added to the auroral module:

1) asymmetric dawn and dusk convection cells and IMF By effect

2) a limit on By (-11<By<7)

3) I added a few lines of comments just before rote and rote to indicate
that we are not going to multiple rote and roth with  the MLT to degree
factor (15) in the current version of TIEGCM (TIEGCM 1.9.1). We will add
them back after we complete our test with comparisons with GUVI and DMSP
data in the next version.

4) A variable named "eflux2d" is included in aurora.F by Barbary to
output energy flux in secondary history files.

Wenbin

----------------------------------------------------------------------
12/3/08 btf:
Add lines to qrj.F and qinite.F to insure non-negative N2 at interfaces.
Search on "fix for CISM". This was recommended by Wenbin via 10/23/08 email.

Set max number of time-dependent namelist read parameters (e.g., bx,by,etc)
from 100 up to 500. See params.F:
mxind_time = 500   ! max number of time-dependent solar index points

12/4/08 btf:
Set sh%nflds and sh%fnames when reading source history (nchist.F).
They were not being set correctly and made the code crash in sub copyhist
(hist.F) on hao linux (altho it was working correctly on bluefire).

12/8/08 btf: Change model_version from tiegcm1.9 to tiegcm1.91 (params.F)

12/8/08 btf: Stan's "final" aurora.F, copied from /home/stans/aurorascs.F.

----------------------------------------------------------------------
12/10/08:
>>>>>>>>>>>>>>>>>>  Commit and release of tiegcm1.91 <<<<<<<<<<<<<<<<<<<
cvs commit -F commit_notes/tiegcm1.91 
cvs tag tiegcm1-91
----------------------------------------------------------------------

2/18/09:
Liying realized that an old version of qrj.F was inadvertently used in
the tiegcm1.91 tag (and in $TGCMROOT/tiegcm1.91/src/qrj.F). The "new"
version was correct in tiegcm1.9. This "new" qrj.F is copied here,
and cvs commit was made w/ -m message explanation. Diffs were mostly
"optimization" of the code, but also included:
         sflux(l)=sfmin(l)*(1+afac(l)*(pind-80.))
         if (sflux(l) .le. 0.8*sfmin(l)) sflux(l) = 0.8*sfmin(l)
The old version had:
        IF (SFLUX(L) .LT. 0.0) SFLUX(L) = 0.0
So results might differ if sflux < 80.
Put copy of the updated qrj.F in $TGCMROOT/tiegcm1.91/modsrc.

2/23/09: 
Confirmed that using the "new" qrj.F (from tiegcm1.9) and the "old" qrj.F 
from tiegcm1.91 show zero differences in results after changing the "old" 
version to use tlbc for tn interfaces, instead of finding the T lbc in 
"top slot". These runs used constant f107=150., so the condition described 
above did not occur.

Now using the new qrj.F while testing the code w/ CISM pre-proc macros
included in the source code (received from Pete Schmitt), but not turned 
on by the Makefile, i.e., still standalone. Added COUPLING := NO and
COUPLING conditionals on pre-proc macros in scripts/Makefile, to indicate 
that CISM flags are not to be set for stand-alone tiegcm.
CISM mods were taken from revision 783 of the LTR-para repository.

Code was tested on bluefire, gale, and oreo.
Committing and tagging as tiegcm1-92
----------------------------------------------------------------------

8/27/09 btf and am:
Increase night time electron densities in qinite.F:

!
! al is sometimes adjusted for different conditions ("tuning knob"):
!      real,parameter :: al(3) = (/5.E4, 5.E3, 5.E3/)  !org 1.1.1
! Using these timegcm values allows removal of minimum Ne in elden.F:
      real,parameter :: al(3)=(/1.5E7,1.5E6,1.5E6/) ! timegcm version

This was in tiegcm1.9, but apparently left out of 1.91 and 1.92.

Original README notes from January, 2008:

1/24/08 btf: mods from Astrid:
am 1/22/08 (qinite.F, elden.F)
  change the flux in qinite
  from
        real,parameter :: al(3) = (/5.E4, 5.E3, 5.E3/)
  to
        real,parameter :: al(3)=(/1.5E7,1.5E6,1.5E6/)
  The new triple values are from TIME-GCM.
  In addition remove the minimum electron density in elden.F

  Motivation:
  the usage of the minimum electron density in elden.F was not consistent
  with the later ion calculation,
  and was leading to an unbalance in electrons and ions.
  It was decided that having a minimum electron density shouldn't
  be necessary if we have a better nighttime ionosphere. However,
  implementing formulations like Titheridge suggested was postponed for
  later. We looked at this a few years ago, and it wasn't straight forward to
  implement. So increasing the night time flux of the three lines (1026,304,584)
  seems reasonable, also TIME-GCM is using the same values.
  The nighttime NE at plev=-2 is around log(Ne)=3.2 at low latitudes. The
  prereversal enhancement is decreasing a bit (around 3-4 m/s) at JRO.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
10/5/09:
- Fix Mknamelist to make tiegcm compatable input file for generic "TGCM" model.
- Update version flags from tiegcm1.91 to tiegcm1.92. See scripts/*.job, and
  src/params.F.

Fix two bugs, pointed out by John Ritterer:
- Use-associate nlonp1 rather than nlonp4 in sub set_dynpot, rdsource.F
- Add ntrigs argument to FFT99B call from sub FFT99, fft9.F

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
12/23/09:
In wei05sc.F (Original mods ~Oct 14):
CNCAR      Routines added to work around non-ANSI trig functions which
C          input degrees instead of radians:  SIND, COSD, ASIND, ATAN2D
In wei05sc.F and wei01sc.F: replace PAUSE statement with call shutdown.
magpres_g: add save attribute to allocatables je1oD_geo and je2oD_geo
(did svn commit here)

12/23/09:
Updating svn trunk with several mods, mainly from $TGCMROOT/tiegcm1.92/src/modsrc:
(see also $TGCMROOT/tiegcm1.92/src/modsrc/README)

New sub sunloc_apex (Original mods by Astrid, 5/22/09)
  files: advance.F  apex_subs.F  magfield.F
    new subroutine sunloc_apex
  change the the calculation of the 
  sun's location from dipole coordinates to apex. This is now conform with 
  the apex coordinate system (the difference is minor 1-3 degrees)

New lower boundary scheme, with new module lbc.F replacing bndry.F
This involved many (about 15) source files.
(Original mods by Foster, 6/26/09)

Increase night time electron densities in qinite.F
(Original mods by Foster and Maute, 8/27/09)
  change the flux in qinite
  from
        real,parameter :: al(3) = (/5.E4, 5.E3, 5.E3/)
  to
        real,parameter :: al(3)=(/0.75E7,0.75E6,0.75E6/)

Update version flags from tiegcm1.91 to tiegcm1.92, see src/params.F.
Fix two bugs, pointed out by John Ritterer:
- Use-associate nlonp1 rather than nlonp4 in sub set_dynpot, rdsource.F
- Add ntrigs argument to FFT99B call from sub FFT99, fft9.F
(Original mods by Foster, 11/14/09)

Bugfix in sub interpol_quad (wei05sc.F). This was found by Tzu-Wei
in December, 2009. See "bug fix by btf" in wei05sc.F.

Doing svn commit here, 12/23/09.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1/5/10:
Use mpi_bcast in sub mp_updatephi (mpi.F), as in timegcm. This
resulted in a modest performance improvement (not as much as in
timegcm). Committed revision 288.

1/20/10 btf:
Fix minor bug in sub calczg, addiag.F. 
Changed c2 = cos(2.*dgtr*float(j)) to
        c2 = cos(2.*dgtr*glat(j))
A 1-day test of tiegcm showed this changed ZG by max of ~3 km near the 
top of the model (much smaller lower, e.g., .125 km diff at zp -4).

2/3/10 btf:
Merged mods for saber/tidi lower boundary option. Several files
  modified, and addition of new source file saber_tidi.F. Also added
  commented saber/tidi ncfiles to default input file (scripts/Mknamelist)
Will commit this before merging mods to add Kp to namelist read.
Revision 292

2/3/10 btf:
Merged mods to add Kp to namelist read. If kp is specified, it will
  be used to calculate hpower and/or ctpoten (see functions hp_from_kp
  and ctpoten_from_kp in util.F). For now, KP cannot be specified in
  a gpi or weimer potential run.
Added commented out KP and description in default namelist input file
  (scripts/Mknamelist).
Added prints of time-dependent solar inputs (power, ctpoten, etc)
  in input.F.
Revision 293

2/3/10:
Now planning to start full year runs with saber/tidi lbc for Qian.
Will set svn tag tiegcm_sabertidi, so these runs can be duplicated later.

Minor fix in sub inp_solar.
Revision 295

2/4/10 maute:
  include IGRF11 from http://www.ngdc.noaa.gov/IAGA/vmod/igrf.html
  file: apex_subs.F
Revision 296

Saved svn tag tiegcm1.92_r296 and put it in $TGCMROOT for testing
by the group.

2/11/10:
Barb's fix to wei01gcm.F: set weictpoten(2) as function of vnx for
each hemisphere, and set ctpoten to average of weictpoten.
This will be r298.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
am 3/11/10
  mpi.F: update send and receive for fields emphi3d,emlam3d,emz3d
     to include the top 3 levels since nmlev = nlev+3
     subroutines mp_updateemphi, mp_updateemlam, mp_updateemz
  efield.F: update addfld call for EMX,EMY,EMZ to put into the right
  height levels (4,nmlevp1). The bottom levels are not used in the
  geographic framework. 

3/24/10:
Bug fixes as per Astrid:
1. dynamo.F subroutine threed: the E_lam wasn't mapped in the horizontal
   plane which gave wrong results close to the geomagnetic equator at
   higher pressure levels (therefore EXB drift was also wrong)
2. efield.F in the mapping from magnetic to geographic grid real values
   are put into integer w/o explicit conversion from real to integer.
   This led to wrong mapping on HAO machine arc.

4/21/10:
Add -qfixed to FFLAGS when using xlf90 (i.e., compiling without MPI).
See AIX section of scripts/Makefile.

Add implicit none to sub set_dynpot in rdsource.F. (in tiegcm1.92 tag,
nlonp1 was not defined in set_dynpot and without implicit none, it
was seg-faulting on bluefire). 

5/4/10:
Added ability to specify 4-byte floats or 8-byte doubles for 4d fields
on secondary histories. New namelist parameter SECH_NBYTE can be either
4 or 8. Default is 4-byte floats. This option does not affect primary
histories. 4-byte secondary files will be about 1/2 the size of 8-byte
files. Before this option, all 4d secondary fields were 8-byte doubles.

Either type of file can be read by f90 and IDL post-processors because
the post-procs always read 4-byte floats regardless of the precision on
the file. tgcmproc_f90 gave straight zeroes for diffs between a 4-byte 
and 8-byte history after a 1-day run.

5/6/10:
Add env vars to tiegcm-linux.job to set up MPI for PGI pgf90 compiler.
(as in ~foster/.cshrc).

5/7/10:
Add extra day for end of a leap year. To run to end of the year:

Non-leap years: Run to mtime 366,0,0. This history will be written to
  the file as 1,0,0, with the year incremented by 1, and can be
  used to start the new year.

Leap years: Run to mtime 367,0,0. This history will be written to
  the file as 1,0,0, with the year incremented by 1, and can be
  used to start the new year.

Changes to advance.F, input.F, nchist.F, params.F

5/7/10:
When building on bluefire with mpi=FALSE (compiler is xlf90 rather
than mpxlf_r), the xlf90 compiler does not accept mod(iyyyy,4), where
iyyyy is an 8-byte integer (see imf.F). To fix this, a new local 4-byte 
integer iyyyy4 is delcared (sub getimf, imf.F), which is then used in 
the mod function call.  This was not necessary under mpxlf_r.

Minor changes to scripts/tiegcm-ibm.job to accomodate mpi=FALSE under AIX.

5/10/10:
Change tgcm_version to "tiegcm_trunk" in params.F, to indicate
the svn trunk development line.  This parameter will be changed 
at the time of release, e.g., to tiegcm1.93.

5/18/10:
Add Liying's DOY-dependent eddy diffusion. New namelist read parameter
EDDY_DIF is 0/1 flag for whether or not to use the DOY-dependent diffusion.
difk, dift, and xmue are now dimensioned (nlev+1,366).  Current default
is EDDY_DIF=0.  Changes to cons.F, comp.F, dt.F, duv.F, minor.F, input.F. 

Deprecating DIFHOR as a namelist input parameter. It is forced to be
on (i.e., difhor=1). If the user sets difhor <= 0, the model will stop
w/ error. See input.F. Later versions will eliminate the flag entirely.

Set tgcm_version = 'tiegcm_trunk' in params.F.

5/18/10:
Add ntask_mpi to history files. This is number of MPI tasks used when
history was written. Changes to nchist.F, output.F, and hist.F.
Commit here.

5/18/10:
In default namelist input file, change gpi_ncfile to gpi_2000001-2009031.nc

5/26/10 commit:
Set tgcm_version = tiegcm1.93 (params.F)
Some changes to saber_tidi.F re missing data and shutdown
Fixing problem w/ rmins at year-end (mtimeinit, h%modeltime) (nchist.F)
Add academic license text at top of lbc.F

Add doc/ subdir to repository.  Currently contains Release_Notes,
svn.log, and README (linked from trunk dir).

Minor changes to job scripts for v1.93. 
Default SOURCE file is $TGCMDATA/TGCM.tiegcm1.93.pcntr_eqnx_smin.nc

5/27/10:
Completely remove DIFHOR from namelist (input.F). Now set integer
parameter difhor=1 in cons.F. This is use-assoc by comp.F and minor.F.
Now, if the user has DIFHOR in the namelist input file, the model
will not recognize it and will stop with an input error. If a model
developer wants to change the flag, they can change it in cons.F and 
recompile.

5/27/10:
Add TEC diagnostic to secondary histories. NE is integrated in
elden.F (using Z) and calls addfld to save TEC. Default namelist file
includes TEC in SECFLDS.

5/28/10: Saving tag tiegcm1.93

5/28/10: Recommitted after excluding SABER_NCFILE, TIDI_NCFILE from the
default namelist (see Mknamelist, tiegcm_default.inp) because they are
unsupported in the Community release. Also recommit tags/tiegcm1.93.
They were commented out, but remove them completely so they will not be seen.
However, they remain in the default namelist in local dirs $TGCMROOT/tiegcm1.93.

7/8/10:
Increased mxhvols and mxsech from 100 to 500 files, see params.F.
This was at request of Qian Wu, who wants to make 100-day runs on
64-bit Linux cerberus.

7/12/10:
Reset nanfatal to 1 at end of sub wrf4d in nchist.F. It was apparently
left off during debugging. It should be turned on by default, so the
model will stop if writing NaNs to history file.

10/3/10: Starting new branch tiegcm_newbuild for new build scripts using
Make.$machine. Source is same as the trunk, all changes are in scripts/.

10/5/10:
In highlatpoten, phihm is passed to sub diff_rimr (called by dynamo),
but diff_rimr declares the arg a scalar. This is actually ok, because
diff_rimr does not reference it, but only passes it to sub insert_pot,
where it is correctly dimensioned. However, I am making this change
to avoid compiler warnings, and to be more clear. This was pointed out
by Jiannan Tu (jiannan_tu@uml.edu).

10/18/10:
Fix addfld call for QJI_TN in dynamics.F (pass qji_tn instead of qji_ti).
Thanks to Art for pointing this out.

10/19/10: Many changes and additions to scripts directory, including new
scripts mknamelist and mkjob. Also a new directory "suites", to contain
scripts that set up a series of runs using mknamelist and mkjob. So far,
only one file in suites to make a series of control runs, called mkmulti_control.

10/20/10: Fix call to addfld for qji_tn in dynamics.F (pointed out by Art).
10/21/10: Moved mkmulti* to control_suite, added perf_suite, but it still
needs work.

11/2/10: Tagging this as tiegcm_newbuild1.0, before rewriting job scripts.

11/4/10: Rewrite of tiegcm-linux.job and tiegcm-ibm.job, but the latter
is untested due to bf outages. Changes to mknamelist. job*.txt are updated 
wrt to job scripts, but suites/ scripts are not up to date with these changes 
yet.  Changed Abspath to abspath.

(iris) tiegcm_newbuild : svn stat --show-updates
M             388   scripts/job_ibm.txt
A               0   scripts/abspath
D             388   scripts/Abspath
M             388   scripts/tiegcm-ibm.job
M             388   scripts/tiegcm_default.inp
M             388   scripts/mknamelist
M             388   scripts/job_linux.txt
M             388   scripts/tiegcm-linux.job

11/23/10:
Merging changes on the trunk to this branch.

11/23/10:
Committing changes made to wking dir around 11/1: remove mp_periodic_f2d
calls in minor.F and divrg.F to remove small differences found when 
running the code w/ different # cores, e.g., small diffs were found
between 4 vs 16 processor runs.

Fix function finterp (util.F, called by getgpi.F) to check for 
model time == bracketed times, to avoid apparent round-off errors that result 
in negative interpolated kp when kp data is 0 (has come down to zero) when 
sec1==iutsec. This problem was found by Liying.

11/24/10:
Allow constant namelist Kp with gpi_ncfile. In this case, the constant
Kp will be used to calculate ctpoten and power, and the gpi data will
be used for f107d and f107a, interpolated to model time. See input.F and 
gpi.F. This was requested by Liying.

12/1/10 btf:
Add svn revision number as a global attribute on history files:
 - Job script issues svnversion command on $modeldir, and passes result 
   to the Makefile as SVN_VERSION via Make.env file
 - Makefile makes include file svn_version.inc, containing char*8 var
   with the version number (e.g., "479M", modified revision 479)
 - The svn_version.inc file is #included into sub nc_define in nchist.F, 
   where it is written to the history file as a global attribute.

Add time-dependent namelist f107 and f107a. Thanks to Karthik for pointing
out that this was missing (its been in timegcm). See f107_time, f107a_time,
ntimes_f107, ntime_f107a, etc in input.F. See also advance.F.

1/7/11: Wenbin and JiuHo found a bug in qjion.F, where line 119:
     |      .5*(ne(k,i)+ne(k+1,i))*(ra1(k,i,lat)*op(k,i)*0.854+
Should be:
     |      .5*(ne(k,i)+ne(k+1,i))*(ra1(k,i,lat)*nop(k,i)*0.854+
i.e., ra1 is chem rate for NO+, not O+.
I have put a comment in qrj.F at this point, but have not yet made 
the change or commit, pending confirmation. This line is correct in 
timegcm, so no bug there.

1/12/11: Commit above bug fix (no comment added in qjion.F)

2/18/11: New option to use Intel compiler on 64-bit hao Linux machines.
There are now 2 Make.machine options for 64-bit hao:
Make.intel_hao64 and Make.pgi_hao64. This also involves 2 different
mpirun commands, see tiegcm-linux.job, and MPIRUN in the Make.machine 
files. Short tests show that the intel-built code is more than 2x faster
than the PGI built code using 4 processors on iris.  No changes to the 
source code in this commit (r514) to the trunk.

2/23/11: Rebuilt openmpi with ifort and installed in 
/home/tgcm/intel/openmpi-1.4.3, so now Make.intel_hao64 has:
MPIF90   = /home/tgcm/intel/openmpi-1.4.3/bin/mpif90
MPIRUN   = /home/tgcm/intel/openmpi-1.4.3/bin/mpirun
See /home/tgcm/intel/openmpi-1.4.3/config.log for config command.

Also built openmpi with pgf90 and installed in 
/home/tgcm/pgi/openmpi-1.4.3, but when trying to compile the model
with mpif90 of this install, it stops immediately complaining about
"-pthreads unknown option". So for now, just using the old paths
in Make.pgi_hao64.

3/1/11:
Merge changes from tiegcm/branches/tiegcm_dyncrit to the trunk to allow
for combined IMF+GPI run. In this case, only f10.7 is used from the GPI
file. With these mods, f10.7 cannot be read from an IMF data file. This
code will read data from either the new imf_OMNI*.nc data files or the
"old" imf_xxxxxxx*.nc data files. Note that the new imf_OMNI*.nc files
do not have f10.7 or Kp data.

3/16/11:
Merge changes from tiegcm/branches/tiegcm_hpss to the tiegcm/trunk to 
  implement the mss -> hpss transition:
svn merge $SVN/tiegcm/trunk@497 $SVN/tiegcm/branches/tiegcm_hpss@HEAD
Followed by several minor changes, and finally commit to tiegcm/trunk.

Changes to namelist input file:
  - New parameter HPSS_PATH: if set, a csh script will be written to
    the execdir, containing hsi commands to copy output files to the hpss.
    The csh script can be executed by the user after the model run.
    However, users are encouraged to use the per script tgcm_put, see below.

  - The following namelist parameters are deprecated: SAVE, SECSAVE, DISPOSE

Added perl script tgcm_put to tiegcm/trunk/scripts. This script will copy
  history disk files to a specified directory on the hpss, including the 
  "contents" string as an hpss annotation (similiar to old mss comment string)

3/17/11:
Remove save and secsave from hist.F, wrhist.F, and mpi.F.

3/19/11:
Merged tiegcm_dyncrit branch to the trunk (r571)

Add check in input.F to enforce providing namelist f107,f107a when
Weimer potential model is requested without GPI data.




!======================================================================

Oct 04 -> May 05:

Development on tiegcm1.6 leading to tiegcm1.7, tiegcm1.8dev1, 
tiegcm1.8dev2, and the tiegcm1.8 "tuning release", dev/tiegcm1.8: 

!======================================================================



10/21/04: Changed #include statements from "file.h" to <file.h>.
Used perl /home/foster/tgcm/scripts/change_incs_bracks.

10/29/04:
Small change to print format statement in advance.F.
Fixed dispose.F to correct password problem in mscomment (see save/dispose.old)

!-----------------------------------------------------------------------

1/10/05:
Copied source from /home/tgcm/tiegcm1.6/src and scripts from ~/tgcm/scripts.
Modifying source for lightning linux cluster, like ~/tgcm/timegcm/src.
This is currently not a CVS working directory -- CVS working directory
is ~/tiegcm/tiegcm, but this dir (from /home/tgcm/tiegcm/src) is more
up to date. At some point (when code is working on lightning), this
should become the CVS working dir.

1/10/05:
Removed nc_xxxx routines from nchist.F, replacing them with the netcdf
functions nf_xxxx. The routine nc_get_var_real (nf_get_var_double) was
being used incorrectly (getting scalar when var is a vector with time
dimension). Now using nf_get_var1_double to get scalar at time itime. 
(see, e.g., reading f107a, f107d, etc). Same for ints that are dimensioned
in time.

1/11/05:
Determined that -fastsse does not work for dynamo (problem w/ rhs).
So mpif90 optimization should be -O2 -fast.

1/12/05:
Cleaning up for lighting: added shutdown routine (util.F), and several
other routines in util.F. Changed output, nchist, etc so that disk
file names can be used for SOURCE, OUTPUT, or SECOUT.

Changed some dimensions to avoid out-of-bounds check by the compiler.
Can now use -g -C to check for out-of-bounds. (see esp, dynamo.F, where
array() was changed to wkarray(), and put in module data).

Removed "old" dynamo option (dynamo_old.F). Now the namelist read parameter
DYNAMO <= 0 -> no dynamo, or
DYNAMO >  0 -> dynamo ("new" only)

tempdir can now be blank (which has same effect as tempdir==.).

2/2/05: This is now a CVS working directory for project tiegcm,
including scripts and src directories. Repository is /home/tgcm/cvs/tiegcm.

Feb, 2005: Rewrote timing module, as in timegcm1.2. See timing.F, and
calls in advance.F and dynamics.F.

2/10/05: Copied updated scripts from ~foster/tgcm/scripts to ~foster/tgcmtiegcm/scripts.

2/10-11/05: Verified that results are the same as 1.6: got 0 diffs between
1.6 and 1.7 runs on the same platform, and near-zero (1.e-5) diffs between
platforms.

2/11/05: Committing to CVS repository, and tagging as tiegcm1-7.

!-----------------------------------------------------------------------

Changes from tiegcm1.7 to tiegcm1.8:

2/28/05: Using k instead of k+1 in mbar calculation in dt.F.

3/18/05: 
Added check_nans, see util.F and nchist.F. Finding nans when
writing prognostic fields is fatal, see nanfatal in nchist.F.  

Putting read of magfield data file back in for use only when
dynamo==0 (was crashing on lightning). See tgcm.F and magfield.F.

Swapped loop order for efficiency near top of sub nodynamo (dynamo.F).

3/28/05:
Merged Astrid's mods to dynamo (/callisto/i/maute/teTex.d/merge_w1.7).
This included 2 new source files: highlatpoten.F and magpres_g.F.
Extensive changes to dynamo.F, current.F, apex.F.

4/4/05 btf:
Added gswm options to bndry.F, addiag.F, dt.F, and duv.F. This eliminates
source files bndry_gswm.F, addiag_gswm.F, dt_gswm.F, and duv_gswm.F.
Did "cvs remove" on the eliminated files. This will take effect with
the next cvs commit.
Also consolidated gswm calls from advance.F to sub getgswm in gswm.F.
Also changed gswm flags and file names for non-migrating tides
(i.e., gswmnmidi and gswmnmisdi changed to gswmnmdi and gswmnmsdi).

4/6/05:
CVS tagged code with "cvs -q tag tiegcm1-7+gswm+maute".
I.e., mods to tiegcm1-7 so far, including gswm and maute mods,
but prior to merging lqian code.

4/6/05:
Merged Liying's mods (lqian/):
Mods to: aurora.F, chemrates.F, dynamics.F, init.F, input.F, newton.F,
qinite.F, qrj.F, tgcm.F, util.F. Removed files xray.F and qtieff.F,
and added new source file soldata.F. There is a new namelist parameter
SD_NCFILE, specifying SEE data netcdf file. The default SEE data file
is $TGCMDATA/see__L3_merged_2005007_007.nc. 

Added this default file to scripts/MkNamelist for tiegcm (commented out). 
Also added copy of this file to exec dir by scripts/tgcm_config. The new 
MkNamelist and tgcm_config were distributed to model scripts directories 
at both hao and scd.

Added new global file attribute for sd_ncfile to histories (nchist.F).
If sd_ncfile is not in use, the attribute value is "[none]".

Commented many addfsech calls (mostly in maute code dynamo, hightlat*, 
magpres*, etc.)

CVS tagged code with "cvs -q tag tiegcm1-7+gswm+maute+lqian", but this
turned out to be incorrect -- it tags the current repository, not the
working directory from which the tag command is given. One must do a
commit, *then* save a tag.  Consequently, we do not have a version from 
after maute dynamo mods but before lqian qrj and SEE data mods.

Broke init_fields (fields.F) into 2 routines: init_4d and init_3d.
This allows compilation on certain flavors of pgf90 (e.g., on HAO Callisto)
Changes to fields.F and init.F.

4/7/05:
Doing a cvs commit, and tagging as tiegcm1-8dev1: this is leading up
to a pre-release of tiegcm1-8. This code is essentially tiegcm1-7 plus 
the following:
  -- maute dynamo mods
  -- lqian euv/qrj and SEE data option
  -- foster gswm mods (combine dt.F and dt_gswm.F, etc.)

4/19-20/05:
Copied Liying's new ~lqian/aurora.F, with qtef fix. This was causing
problems on lightning with 8 processors.

4/21/05: Made 2 10-day runs, one with periodic points and boundary
longitudes set in dt.F, and one without. Making these calls was
recommended by Wenbin (see ~foster/tgcm/tiegcm/doc/wenbin). However,
there were zero differences in all major fields after 10 days,
according to tgcmproc_f90. 

Uncommented mp_bndlons_f3d and mp_periodic_f3d in dt.F, as per
Wenbin's request.

4/22/05: 
Saving this code as "tiegcm1.8dev2", CVS tag "tiegcm1-8dev2".

Executed:
cvs commit -m "tag tiegcm1-8dev2: dynamo currents and high-latitude options, new EUV/qrj parameterization, Timed SEE data option, updated chemrates"

cvs tag tiegcm1-8dev2
!-----------------------------------------------------------------------

5/3/05:
Added sub expand_path in util.F, called by getfile, so user can imbed
env vars in file paths (e.g. in SOURCE, GPI_FILE, etc). E.g.:

 SOURCE='$TGCMDATA/TGCM.tiegcm.p001-2002-080.nc'
 SOURCE='$MYDIR/FOSTER.tiegcm1.8.peqnx_001.nc'
 SOURCE='/hao/$MYSUBDIR/FOSTER.tiegcm1.8.peqnx_001.nc'
 SOURCE='$MYDIR/$MYSUBDIR/FOSTER.tiegcm1.8.peqnx_001.nc'
 SOURCE='/TGCM/data/TGCM.tiegcm.p001-2002-080.nc'

Note expand_path is recursive, so multiple env vars can be imbedded in
the path, as in example 4 above. If a '$' is not found in the path,
expand_path simply returns without changing path, e.g., in the last
example above.

Committing this to CVS, and giving it to Ray for tuning prior to
the "pre-release" to hao AIM. This model is saved in
$TGCMROOT/dev/tiegcm1.8/ at both hao and scd.

5/5/05: Ray says this is ok for tuning release. Tagging as tiegcm1-8tune.
Source is in $TGCMDATA/dev/tiegcm1.8/ (HAO and SCD). Also tar file is
/toshi/ftp/pub/tgcm/tar/tiegcm1.8tune.tar.

5/5/05: Allow "/TGCM/" to be an mspath (in addition to "/LOGNAME/" in 
function is_mspath (util.F)

Enable env var to be included in file path names, e.g.,
SOURCE = '$TGCMDATA/...'

5/11/05: Removed mpi_barrier call in putms to prevent job from hanging
when DISPOSE=1 (putms is called by master task only).

5/12/05: Preparing tiegcm1.8 "tuning release", see doc/README_1.8tune
CVS tag will be tiegcm1.8tune, source in $TGCMROOT/dev/tiegcm1.8.

!-----------------------------------------------------------------------
Mods after tiegcm1.8 tuning release (i.e., after 3:30 pm, May 12, 2005):

5/12/05: Fixed function b_search (util.F) to compile on SGI tempest.

5/27/05: Copied new soldata.F and util.F from Liying, so shutdown is
called if model date/time are not found in available SEE data.
(I changed function name real_bsearch to int_bsearch in util.F,
but this was later changed to b_search on 7/28)

Also, put int dummy declaration before inarray declaration in both
int_bsearch and long_bsearch, for the SGI compiler (as in 5/12 above).

7/8/05: Changed length of line read by sub rmcomments (util.F) from 
80 to 6400, so namelist read lines in .inp file can be long (thanks to 
Cedric St-Jean).

7/20/05: In soldata.F, changed 
  include "netcdf.inc" to 
  include <netcdf.inc>

7/21/05: Fix function my_msrcp so only master MPI task does msrcp command.

7/28-29/05: Demerged first attempts to remove storing t,u,v lbc in top
slot. This was premature. Saved this version of cvs working directory
in /e/foster/tiegcm/tiegcm-mywrk. Then merged in the above changes, since
5/12, and included Astrid's mods for new lamdas, qjoule (which were
saved as tiegcm1-8tune1 earlier this week).

Also saving several minor changes in scripts (updated gpi and ncep files
in tgcm_config and MkNamelist, added SEE data file, removed dave and
blackforest from some job scripts (they were still in repos versions,
new locations for lightning netcdf libs,etc).

7/29/05: Made default test runs on callisto (hao), bluesky, lightning,
and tempest.  Doing cvs commit, and tagging this as tiegcm1-8tune2.

7/25/07: am
rewritten lamdas.F; correct Joule heating for ions qjoule.F; include vertical 
velocity difference for Joule heating calculation which goes into neutrals 
qjoule.F

9/22/05: Updated apex_subs.F from Astrid -- this has new apex coefficients
for 1995, 2000, 2005.. Copied her file from /home/maute/apex.d/modsrc_apexmod.

Also improved expand_path (util.F) for expanding env vars used in
file specs in namelist read. 

1/18/06: 
  Fix "mgr bug" in oplus 
  Reference lev1 (rather than lev0) for tn lbc in comp.F, because lbc is
    still in top slot.

Doing cvs commit to update these 2 changes and the new apex.F. 

#-----------------------------------------------------------------------
4/2/07: See dynamo mod by Astrid, in ../consult/astrid.dynamo.
See also $TGCMROOT/tiegcm1.8/src/modsrc/dynamo.F and README.

8/13/07 btf:
Changed init of dynpot lons from nlonp4 to nlonp1 in sub set_dynpot
(rdsource.F) because dynpot is dimensioned nlonp1 (fields.F). This
subroutine is called only for non-mpi serial runs. This was pointed
out by George Millward.

!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
10/23/07  am
  Minor correction to dynamo.F, pointed out by Wenbin:
  dynamo.F: line 843-844
  correct the hemispherical adjustment of the high latitude electric potential
  This adjustment is done for asymmetric high latitude potential pattern for
  HEELIS and Weimer (not working at the moment).
  Therefore, fac = 1 (line 842)
  Heelis pattern is hemispherically symmetric, therfore 
  phihm(i,southH_n)-phihm(i,northH_n) = 0
  For modified Heelis (mod_heelis=.true.), we don't want this correction, 
  since it's symmetric anyway,
  therefore fac = 0.

  This was an error in the code, but since we had only hemispherically 
  symmetric potential pattern, we didn't get wrong results.

10/25/07 am
  modifications to use directly the calculated electric field from 
  the electrodynamo part instead of starting from the electric potential
  in efield.F.
  NOTE: mpi is done for each field separately instead of combining the
    field and then do one passing (see ).

10/25/07 btf
Updated scripts directory from hao:$TGCMROOT/tiegcm1.8/scripts and commit

11/7/07 btf: Changed use-assoc from params module in heelis.F to avoid
conflict w/ dummy args. This is for the IRIX compiler (it was not a 
problem under AIX).

!--------------------------------------------------------------------------
11/7/07 btf:
Begin major revision to use history mechanism and other improvements from 
tiegcm-hist-lbc, but retain 97 km lbc.

11/9/07 btf: Many changes, including copying several files from tiegcm-hist-lbc
model (nchist.F, output.F, hist.F, etc). This code runs but produces bad output
(NaNs, 0's, etc).  The "top slot" convention for t,u,v has not yet been removed. 
Saved this as tiegcm_runs1.tar. This code has removed addfsech, and has addfld, 
but the addfsech calls have not yet been converted to addfld calls.

11/14/07: Is running now and results look ok. "Top slot" convention has been
removed. Removed OX and O3, and 3d fields gswm_rfu,rfv, eddy, vo3, sco3, o1d.
Am now completing conversion of addfsech calls to addfld.

Had to set mxlev==ilev1==nlevp1 in mp_gather2root_sech in mpi.F because
nmlev > nlevp1 because of extra levels below lbc in dynamo.

11/19/07: Added Astrid's electric field calcs in dynamo, w/ changes to efield.
Now emx,emy,emz are calculated in efield only in first timestep, then efield is
calculated in dynamo as emphi3d, emlam3d, and ez3d, and copied to emx,y,z in
efield.

11/20/07: All addfsech calls are now converted to addfld.
Saved /oreo/d/foster/tiegcm/tiegcm1.81.tar

11/26/07: Have now made a full year 2002 run w/ this code. All primary files,
and selected secondary files, w/ utproc plots are in /aim/d/tgcm/tiegcm1.81_yr02.

Now preparing to do a commit, and will save tag tiegcm1-81. 
This code does *not* include most of the mods from $TGCMROOT/tiegcm1.8/src/modsrc.
Will notify the "dev" group about this commit, and suggest a meeting
to decide next steps, like including changes from tiegcm1.8/src/modsrc.
=======

